<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PARAGON ANALYTICS</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
    background: radial-gradient(circle at top, #16002b, #040010);
    color: #ffffff;
    font-family: Arial, sans-serif;
    text-align: center;
}
button {
    padding: 10px 18px;
    margin: 6px;
    border-radius: 6px;
    border: none;
    font-weight: bold;
    cursor: pointer;
}
.primary { background: gold; color: black; }
.secondary { background: #333; color: white; }
select {
    padding: 8px;
    border-radius: 6px;
}
.panel {
    max-width: 1100px;
    margin: auto;
    padding: 10px;
}
canvas {
    background: rgba(255,255,255,0.04);
    border-radius: 10px;
}
.grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
    gap: 10px;
}
.card {
    background: rgba(255,255,255,0.08);
    padding: 10px;
    border-radius: 10px;
}
.value { font-size: 18px; font-weight: bold; }
textarea {
    width: 95%;
    height: 120px;
    border-radius: 8px;
    padding: 8px;
}
</style>
</head>

<body>

<h2>PARAGON ANALYTICS</h2>
<p>Automated Business Intelligence Platform</p>

<input type="file" id="csvFile"><br>

<select id="columnSelect">
    <option value="8">Revenue</option>
    <option value="9">Cost</option>
    <option value="10">Profit</option>
    <option value="5">Units Sold</option>
    <option value="11">Marketing Spend</option>
    <option value="12">Delivery Days</option>
    <option value="15">Stock Level</option>
</select>

<br>
<button class="primary" onclick="loadCSV()">Load CSV</button>
<button class="secondary" onclick="runAnalytics()">Run Intelligence</button>
<button class="secondary" onclick="exportPDF()">Export PDF</button>

<div class="panel">

<canvas id="chart"></canvas>

<h3>Risk Intelligence</h3>
<div class="grid" id="riskPanel"></div>

<h3>KPI Ranking</h3>
<div class="grid" id="kpiPanel"></div>

<h3>Product Segmentation</h3>
<div class="grid" id="segmentPanel"></div>

<h3>AI Executive Explanation</h3>
<textarea id="aiText"></textarea>

</div>

<script>
let rawData = [];
let chart;
let riskCache, forecastCache, kpiCache, segmentCache, accuracyCache;

/* ---------------- CSV LOAD ---------------- */

function loadCSV() {
    const file = document.getElementById("csvFile").files[0];
    if (!file) return alert("Upload CSV first.");

    const reader = new FileReader();
    reader.onload = e => {
        rawData = e.target.result.trim().split("\n").slice(1)
            .map(r => r.split(","));
        alert("CSV Loaded Successfully");
    };
    reader.readAsText(file);
}

/* ---------------- RUN ENGINE ---------------- */

function runAnalytics() {
    if (!rawData.length) return alert("Load CSV first.");

    const colIndex = parseInt(document.getElementById("columnSelect").value);
    const values = rawData.map(r => parseFloat(r[colIndex])).filter(n=>!isNaN(n));
    const products = rawData.map(r => r[4]);

    const smooth = movingAverage(values,3);
    forecastCache = forecastModel(smooth);
    riskCache = calculateRisk(values);
    kpiCache = calculateKPIs(values);
    accuracyCache = forecastAccuracy(values, smooth);
    segmentCache = segmentProducts(products,values);

    renderChart(values,smooth,forecastCache);
    renderRisk(riskCache, accuracyCache);
    renderKPI(kpiCache, accuracyCache);
    renderSegments(segmentCache);
    generateAIText();
}

/* ---------------- FORECAST ENGINE ---------------- */

function movingAverage(data,w){
    return data.map((v,i)=>{
        let slice=data.slice(Math.max(0,i-w+1),i+1);
        return slice.reduce((a,b)=>a+b,0)/slice.length;
    });
}

function forecastModel(series){
    let trend=(series.at(-1)-series[0])/series.length;
    let volatility=std(series);
    let base=series.at(-1);

    let values=[];
    for(let i=1;i<=3;i++){
        let value = base + (trend*i) - (volatility*0.25);
        values.push(Math.round(value));
    }

    return {
        values,
        upper: values.map(v=>Math.round(v*1.1)),
        lower: values.map(v=>Math.round(v*0.9))
    };
}

/* ---------------- FORECAST ACCURACY ---------------- */

function forecastAccuracy(actual, smooth){
    let errors=[];
    for(let i=3;i<actual.length;i++){
        let predicted = smooth[i-1];
        let real = actual[i];
        if(real>0){
            errors.push(Math.abs((real-predicted)/real));
        }
    }
    let mape = mean(errors);
    let accuracy = Math.max(0, (1 - mape) * 100);
    return accuracy.toFixed(1);
}

/* ---------------- RISK ENGINE ---------------- */

function calculateRisk(data){
    const volatility=std(data);
    const trend=Math.abs((data.at(-1)-data[0])/data.length);
    const quality=100-(countNaN(data)/data.length)*100;

    const riskScore =
        (volatility/mean(data))*50 +
        (1/Math.max(trend,1))*30 +
        (100-quality)*0.2;

    let level="LOW";
    if(riskScore>60) level="HIGH";
    else if(riskScore>35) level="MEDIUM";

    return {
        volatility:volatility.toFixed(1),
        trend:trend.toFixed(1),
        quality:quality.toFixed(1)+"%",
        score:riskScore.toFixed(1),
        level
    };
}

/* ---------------- KPI ENGINE ---------------- */

function calculateKPIs(data){
    return {
        max: Math.max(...data),
        min: Math.min(...data),
        avg: mean(data).toFixed(0),
        growth: (((data.at(-1)-data[0])/data[0])*100).toFixed(1)+"%"
    };
}

/* ---------------- PRODUCT SEGMENTATION ---------------- */

function segmentProducts(products,values){
    let map={};
    products.forEach((p,i)=>{
        if(!map[p]) map[p]=0;
        map[p]+=values[i];
    });
    return Object.entries(map)
        .sort((a,b)=>b[1]-a[1]);
}

/* ---------------- AI TEXT ---------------- */

function generateAIText(){
    let text =
`Paragon Analytics Summary:

Operational Risk Level: ${riskCache.level}
Forecast Accuracy Score: ${accuracyCache}%

Average Value: ${kpiCache.avg}
Overall Growth: ${kpiCache.growth}
Top Performing Product: ${segmentCache[0][0]}

Next Forecast Values:
${forecastCache.values.join(", ")}

Recommended Actions:
- Monitor volatility closely.
- Prioritize top performing products.
- Maintain buffer capacity for forecast uncertainty.
- Use accuracy score to guide confidence in planning.`;

    document.getElementById("aiText").value = text;
}

/* ---------------- UTILITIES ---------------- */

function mean(a){ return a.reduce((x,y)=>x+y,0)/a.length; }
function std(a){
    let m=mean(a);
    return Math.sqrt(mean(a.map(x=>(x-m)**2)));
}
function countNaN(a){ return a.filter(x=>isNaN(x)).length; }

/* ---------------- UI RENDER ---------------- */

function renderChart(actual,smooth,forecast){
    if(chart) chart.destroy();
    const labels=[...actual.map((_,i)=>"P"+(i+1)),"F1","F2","F3"];

    chart=new Chart(document.getElementById("chart"),{
        type:"line",
        data:{
            labels,
            datasets:[
                {label:"Actual",data:actual,borderWidth:2},
                {label:"Smoothed",data:smooth,borderDash:[5,5]},
                {label:"Forecast",data:[...Array(actual.length).fill(null),...forecast.values],borderDash:[3,3]}
            ]
        }
    });
}

function renderRisk(r, acc){
    document.getElementById("riskPanel").innerHTML=`
    <div class="card">Volatility<div class="value">${r.volatility}</div></div>
    <div class="card">Trend<div class="value">${r.trend}</div></div>
    <div class="card">Data Quality<div class="value">${r.quality}</div></div>
    <div class="card">Risk Score<div class="value">${r.score}</div></div>
    <div class="card">Risk Level<div class="value">${r.level}</div></div>
    <div class="card">Forecast Accuracy<div class="value">${acc}%</div></div>
    `;
}

function renderKPI(k, acc){
    document.getElementById("kpiPanel").innerHTML=`
    <div class="card">Max<div class="value">${k.max}</div></div>
    <div class="card">Min<div class="value">${k.min}</div></div>
    <div class="card">Average<div class="value">${k.avg}</div></div>
    <div class="card">Growth<div class="value">${k.growth}</div></div>
    `;
}

function renderSegments(seg){
    document.getElementById("segmentPanel").innerHTML =
        seg.map(s=>`
        <div class="card">
            ${s[0]}
            <div class="value">${Math.round(s[1])}</div>
        </div>
        `).join("");
}

/* ---------------- PDF EXPORT ---------------- */

async function exportPDF(){
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    pdf.text("PARAGON ANALYTICS REPORT",10,10);
    pdf.text("Risk Level: "+riskCache.level,10,25);
    pdf.text("Risk Score: "+riskCache.score,10,35);
    pdf.text("Forecast Accuracy: "+accuracyCache+"%",10,45);
    pdf.text("Forecast: "+forecastCache.values.join(", "),10,55);
    pdf.text("Top Product: "+segmentCache[0][0],10,65);
    pdf.text("Average Value: "+kpiCache.avg,10,75);

    pdf.text("AI Summary:",10,90);
    pdf.text(document.getElementById("aiText").value,10,100,{maxWidth:180});

    pdf.save("paragon_report.pdf");
}
</script>

</body>
</html>
