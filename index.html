<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PARAGON ANALYTICS v2.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  background: radial-gradient(circle at top, #14002a, #050012);
  color: white;
  font-family: Arial, sans-serif;
  text-align: center;
}
button, select {
  padding: 10px;
  margin: 5px;
  border-radius: 6px;
  border: none;
  font-weight: bold;
}
.primary { background: gold; color:black; }
.secondary { background: #333; color:white; }
.panel { max-width:1200px; margin:auto; padding:10px; }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:14px; }
.card { background:rgba(255,255,255,0.08); padding:12px; border-radius:10px; }
.value { font-size:18px; font-weight:bold; }
.alert-critical { background:#9b0000; padding:8px; border-radius:6px; margin:6px; }
.alert-warning { background:#8a6d00; padding:8px; border-radius:6px; margin:6px; }
.alert-info { background:#006b2d; padding:8px; border-radius:6px; margin:6px; }
canvas { background:rgba(255,255,255,0.05); border-radius:10px; margin-top:18px; }
textarea { width:96%; height:260px; border-radius:8px; padding:10px; }
</style>
</head>

<body>

<h2>PARAGON ANALYTICS — BUSINESS AI v2.1</h2>
<p>Validated, Explainable Business Intelligence Engine</p>

<input type="file" id="csvFile"><br>

<select id="metricSelect">
  <option value="revenue">Revenue</option>
  <option value="cost">Cost</option>
  <option value="units">Units Sold</option>
</select>

<select id="aggregationSelect">
  <option value="raw">Raw</option>
  <option value="week">Weekly</option>
  <option value="month" selected>Monthly</option>
  <option value="quarter">Quarterly</option>
</select>

<br>
<button class="primary" onclick="loadCSV()">Load CSV</button>
<button class="secondary" onclick="runAnalytics()">Run Intelligence</button>
<button class="secondary" onclick="exportPDF()">Export Executive PDF</button>

<div class="panel">

<div id="alertPanel"></div>

<canvas id="lineChart"></canvas>
<canvas id="kpiChart"></canvas>

<div class="grid">
  <canvas id="productChart"></canvas>
  <canvas id="financeChart"></canvas>
</div>

<h3>Risk & Confidence</h3>
<div class="grid" id="riskPanel"></div>

<h3>Scenario Forecast</h3>
<div class="grid" id="scenarioPanel"></div>

<h3>Executive Intelligence</h3>
<textarea id="aiText"></textarea>

</div>

<script>
let rawRows=[], headers=[], charts={}, cache={}, alerts=[];
let colMap={};

/* ================= SMART COLUMN MAPPING ================= */

function normalize(h){
  return h.toLowerCase().replace(/[^a-z0-9]/g,"");
}

function mapColumns(headers){
  let map={};
  headers.forEach((h,i)=>{
    let n=normalize(h);
    if(n.includes("date")) map.date=i;
    if(n.includes("product")||n.includes("item")||n.includes("sku")) map.product=i;
    if(n.includes("revenue")||n.includes("sales")||n.includes("turnover")) map.revenue=i;
    if(n.includes("cost")||n.includes("expense")||n.includes("cogs")) map.cost=i;
    if(n.includes("unit")||n.includes("qty")||n.includes("quantity")) map.units=i;
  });
  return map;
}

/* ================= LOAD CSV ================= */

function loadCSV(){
  const file = csvFile.files[0];
  if(!file) return alert("Upload CSV first.");
  const reader = new FileReader();
  reader.onload = e => {
    const lines = e.target.result.trim().split("\n");
    headers = lines[0].split(",").map(h=>h.trim());
    rawRows = lines.slice(1).map(r=>r.split(","));
    colMap = mapColumns(headers);
    alert("CSV loaded & columns auto-mapped.");
  };
  reader.readAsText(file);
}

/* ================= VALIDATION ================= */

function validate(parsed){
  let issues=[], warnings=[];
  if(parsed.length<12) warnings.push("Dataset is small for forecasting.");
  if(parsed.some(r=>r.value<=0)) issues.push("Negative or zero values detected.");
  return {issues,warnings,score:Math.max(50,100-issues.length*30-warnings.length*10)};
}

/* ================= MAIN ENGINE ================= */

function runAnalytics(){
  alertPanel.innerHTML=""; alerts=[];
  const metric = metricSelect.value;

  if(!colMap.date || !colMap.product || !colMap[metric])
    return alert("Required columns not detected automatically.");

  const parsed = rawRows.map(r=>({
    date:new Date(r[colMap.date]),
    value:parseFloat(r[colMap[metric]]),
    product:r[colMap.product],
    revenue:colMap.revenue!=null?parseFloat(r[colMap.revenue]):null,
    cost:colMap.cost!=null?parseFloat(r[colMap.cost]):null
  })).filter(r=>isFinite(r.value)&&!isNaN(r.date));

  const v=validate(parsed);
  if(v.issues.length){show(v.issues,"critical");return;}
  show(v.warnings,"warning");

  const values=parsed.map(p=>p.value);
  const smooth=exp(values,0.35);
  const forecast=forecastModel(smooth);
  const season=seasonality(parsed);
  const anomalies=detectAnomalies(values);
  const confidence=calcConfidence(values,season,anomalies,v.score);
  const risk=riskModel(values,confidence);
  const kpi=kpis(values);
  const segments=segment(parsed);
  const finance=financeModel(parsed,metric);

  cache={confidence,risk,kpi,segments,finance,season,anomalies,v};

  renderCharts(values,smooth,forecast,kpi,segments,finance);
  renderRisk(risk,confidence);
  renderScenarios(forecast);
  renderText(metric);
}

/* ================= CORE LOGIC ================= */

function exp(d,a){let s=[d[0]];for(let i=1;i<d.length;i++)s.push(a*d[i]+(1-a)*s[i-1]);return s;}

function forecastModel(s){
  let t=(s[s.length-1]-s[Math.max(0,s.length-6)])/6;
  let b=s[s.length-1];
  return {base:[b+t,b+2*t,b+3*t]};
}

function seasonality(d){
  let m={};d.forEach(x=>{let k=x.date.getMonth();m[k]=(m[k]||0)+x.value});
  let v=Object.values(m);return std(v)/mean(v)*100;
}

function calcConfidence(v,season,anom,q){
  let c=100 - season*0.4 - anom.length*5;
  return Math.max(30,Math.min(90,(c+q)/2));
}

function riskModel(v,c){
  let vol=std(v)/mean(v)*100;
  let score=vol*0.6+(100-c)*0.4;
  return {vol:vol.toFixed(1),score:score.toFixed(1),level:score>60?"HIGH":score>40?"MEDIUM":"LOW"};
}

function kpis(v){
  return {max:Math.max(...v),min:Math.min(...v),avg:mean(v),growth:((v[v.length-1]-v[0])/Math.abs(v[0])*100).toFixed(1)};
}

function segment(p){
  let m={};p.forEach(x=>m[x.product]=(m[x.product]||0)+x.value);
  return Object.entries(m).sort((a,b)=>b[1]-a[1]);
}

function financeModel(p,metric){
  if(metric!=="revenue"||!colMap.cost) return null;
  let rev=p.reduce((a,b)=>a+b.revenue,0);
  let cost=p.reduce((a,b)=>a+b.cost,0);
  return {rev,cost,profit:rev-cost};
}

/* ================= RENDER ================= */

function renderCharts(v,s,f,k,seg,fin){
  destroy("line");
  charts.line=new Chart(lineChart,{type:"line",data:{labels:v.map((_,i)=>i+1),datasets:[
    {label:"Actual",data:v},
    {label:"Smoothed",data:s,borderDash:[4,4]},
    {label:"Forecast",data:[...Array(v.length).fill(null),...f.base],borderDash:[3,3]}
  ]}});

  destroy("kpi");
  charts.kpi=new Chart(kpiChart,{type:"bar",data:{labels:["Max","Min","Avg","Growth"],datasets:[{data:Object.values(k)}]}});

  destroy("prod");
  charts.prod=new Chart(productChart,{type:"pie",data:{labels:seg.map(s=>s[0]),datasets:[{data:seg.map(s=>s[1])}]}});

  if(fin){
    destroy("fin");
    charts.fin=new Chart(financeChart,{type:"pie",data:{labels:["Revenue","Cost","Profit"],datasets:[{data:[fin.rev,fin.cost,fin.profit]}]}})
  }
}

function renderRisk(r,c){
  riskPanel.innerHTML=
  `<div class="card">Volatility<div class="value">${r.vol}%</div></div>
   <div class="card">Confidence<div class="value">${c.toFixed(1)}%</div></div>
   <div class="card">Risk Level<div class="value">${r.level}</div></div>`;
}

function renderScenarios(f){
  scenarioPanel.innerHTML=
  `<div class="card">Base<div class="value">${f.base.join(", ")}</div></div>`;
}

function renderText(metric){
  let t=`EXECUTIVE SUMMARY\n\n`;
  t+=`Confidence: ${cache.confidence.toFixed(1)}%\n`;
  t+=`Risk Level: ${cache.risk.level}\n`;
  t+=`Seasonality Strength: ${cache.season.toFixed(1)}%\n`;
  if(metric==="revenue"&&cache.finance)
    t+=`Profit Margin: ${(cache.finance.profit/cache.finance.rev*100).toFixed(1)}%\n`;
  else
    t+=`Profit Margin: Not applicable for selected metric\n`;
  aiText.value=t;
}

function show(list,type){
  list.forEach(t=>{
    let d=document.createElement("div");
    d.className=type==="critical"?"alert-critical":type==="warning"?"alert-warning":"alert-info";
    d.innerText=t;alertPanel.appendChild(d);
  });
}

function destroy(n){if(charts[n])charts[n].destroy();}

function mean(a){return a.reduce((x,y)=>x+y,0)/a.length;}
function std(a){let m=mean(a);return Math.sqrt(mean(a.map(x=>(x-m)**2)));}

async function exportPDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  pdf.text("PARAGON ANALYTICS — EXECUTIVE REPORT",10,10);
  pdf.text(aiText.value,10,20,{maxWidth:180});
  pdf.save("paragon_executive_v2_1.pdf");
}
</script>
</body>
</html>
