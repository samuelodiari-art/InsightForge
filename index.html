<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Paragon Analytics</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: system-ui, Arial;
  background: linear-gradient(135deg, #3b136f, #b08d2f);
  color: white;
  text-align: center;
  padding: 15px;
}

h1 {
  color: #ffd700;
}

button {
  padding: 14px 24px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  margin: 8px;
  cursor: pointer;
}

.primary { background:#ffd700; color:black; }
.secondary { background:#5c2ca6; color:white; }

select,input { padding:10px; border-radius:6px; }

.card {
  background: rgba(0,0,0,0.35);
  padding:15px;
  border-radius:12px;
  margin-top:15px;
}

canvas { margin-top:20px; max-width:100%; }

.stat { margin:6px 0; }

</style>
</head>
<body>

<h1>ðŸš€ Paragon Analytics</h1>
<p><b>Smart Business Intelligence and Forecasting</b></p>

<input type="file" id="fileInput" accept=".csv"><br><br>

<button class="secondary" onclick="loadCSV()">Load CSV</button><br><br>

<select id="columnSelect"></select><br><br>

<button class="primary" onclick="runAnalysis()">Run AI Analysis</button>
<button class="secondary" onclick="downloadPDF()">Download Report PDF</button>

<div id="status" class="card">Waiting for CSV...</div>

<canvas id="chart"></canvas>

<div id="insights" class="card" style="display:none;"></div>

<script>
let rawValues = [];
let labels = [];
let forecast = [];
let upper = [];
let lower = [];
let chart;

function loadCSV(){
  const file = document.getElementById("fileInput").files[0];
  if(!file){ alert("Select a CSV file"); return; }

  const reader = new FileReader();
  reader.onload = e => {
    const rows = e.target.result.trim().split("\n").map(r=>r.split(","));
    const headers = rows[0];
    const select = document.getElementById("columnSelect");
    select.innerHTML = "";
    headers.forEach(h=>{
      const opt = document.createElement("option");
      opt.value = h.trim();
      opt.textContent = h.trim();
      select.appendChild(opt);
    });
    window.csvRows = rows;
    document.getElementById("status").innerHTML = "âœ… CSV Loaded Successfully";
  };
  reader.readAsText(file);
}

function runAnalysis(){
  const col = document.getElementById("columnSelect").value;
  if(!window.csvRows){ alert("Load CSV first"); return; }

  const headers = window.csvRows[0];
  const idx = headers.indexOf(col);
  rawValues = [];
  labels = [];

  for(let i=1;i<window.csvRows.length;i++){
    const v = parseFloat(window.csvRows[i][idx]);
    if(!isNaN(v)){
      rawValues.push(v);
      labels.push("Row "+i);
    }
  }

  forecastEngine();
  renderChart();
  buildInsights();

  document.getElementById("status").innerHTML = "âœ… AI Analysis Complete";
}

function forecastEngine(){
  // Smoothing (moving average)
  let smooth = [];
  for(let i=0;i<rawValues.length;i++){
    let slice = rawValues.slice(Math.max(0,i-2), i+1);
    smooth.push(slice.reduce((a,b)=>a+b,0)/slice.length);
  }

  // Linear regression
  const n = smooth.length;
  const x = smooth.map((_,i)=>i+1);
  const y = smooth;

  const sumX = x.reduce((a,b)=>a+b,0);
  const sumY = y.reduce((a,b)=>a+b,0);
  const sumXY = x.reduce((s,xi,i)=>s+xi*y[i],0);
  const sumX2 = x.reduce((s,xi)=>s+xi*xi,0);

  const slope = (n*sumXY - sumX*sumY)/(n*sumX2 - sumX*sumX);
  const intercept = (sumY - slope*sumX)/n;

  forecast = [];
  upper = [];
  lower = [];

  const std = Math.sqrt(y.map(v=>(v-average())**2).reduce((a,b)=>a+b,0)/n);

  for(let i=1;i<=5;i++){
    const pred = slope*(n+i)+intercept;
    forecast.push(Math.round(pred));
    upper.push(Math.round(pred + std));
    lower.push(Math.round(pred - std));
    labels.push("F"+i);
  }
}

function average(){
  return rawValues.reduce((a,b)=>a+b,0)/rawValues.length;
}

function renderChart(){
  const ctx = document.getElementById("chart");

  if(chart) chart.destroy();

  chart = new Chart(ctx,{
    type:"line",
    data:{
      labels,
      datasets:[
        {
          label:"Actual",
          data:[...rawValues, ...Array(5).fill(null)],
          borderWidth:3
        },
        {
          label:"Forecast",
          data:[...Array(rawValues.length).fill(null), ...forecast],
          borderDash:[5,5],
          borderWidth:2
        },
        {
          label:"Upper Confidence",
          data:[...Array(rawValues.length).fill(null), ...upper],
          borderDash:[2,2]
        },
        {
          label:"Lower Confidence",
          data:[...Array(rawValues.length).fill(null), ...lower],
          borderDash:[2,2]
        }
      ]
    }
  });
}

function buildInsights(){
  const avg = Math.round(average());
  const min = Math.min(...rawValues);
  const max = Math.max(...rawValues);
  const growth = (((rawValues.at(-1)-rawValues[0])/rawValues[0])*100).toFixed(1);

  document.getElementById("insights").style.display="block";
  document.getElementById("insights").innerHTML = `
    <h3>ðŸ“Š Live Insights</h3>
    <div class="stat">Average: ${avg}</div>
    <div class="stat">Min: ${min}</div>
    <div class="stat">Max: ${max}</div>
    <div class="stat">Growth: ${growth}%</div>
    <div class="stat">Forecast (5): ${forecast.join(", ")}</div>
  `;
}

async function downloadPDF(){
  if(!chart){ alert("Run analysis first"); return; }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  pdf.setFontSize(18);
  pdf.text("Paragon Analytics", 14, 20);
  pdf.setFontSize(12);
  pdf.text("Smart Business Intelligence and Forecasting", 14, 28);

  const img = chart.toBase64Image();
  pdf.addImage(img, "PNG", 10, 35, 180, 90);

  pdf.text(document.getElementById("insights").innerText, 14, 135);

  pdf.save("Paragon_Analytics_Report.pdf");
}
</script>

</body>
</html>
