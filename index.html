<!DOCTYPE html>
<!--
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘            PARAGON ANALYTICS â€” Executive Forecasting          â•‘
  â•‘                   GitHub Pages Ready v2.0                     â•‘
  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
  â•‘  BUGS FIXED FROM v1:                                          â•‘
  â•‘  1. Slope now uses RECENT EMA tail (last 25%) not global      â•‘
  â•‘     firstâ†’last, preventing misleading forecasts on            â•‘
  â•‘     non-stationary series.                                    â•‘
  â•‘  2. Confidence score now uses RÂ² + sample penalty instead     â•‘
  â•‘     of the arbitrary "60 + length - vol*50" formula.          â•‘
  â•‘  3. All 3 forecast periods now visible in main UI             â•‘
  â•‘     (v1 only showed Period +1 in scenario cards).             â•‘
  â•‘  4. CSV parser handles quoted fields ("value,with,commas").   â•‘
  â•‘  5. Date/time column auto-detected for real X-axis labels.    â•‘
  â•‘  6. PDF chart re-rendered with light theme; no more dark      â•‘
  â•‘     canvas embedded on white paper.                           â•‘
  â•‘  7. EMA alpha & forecast horizon now user-controllable.       â•‘
  â•‘  8. "Load Sample Data" â€” zero-friction demo mode.             â•‘
  â•‘  9. RÂ² goodness-of-fit shown alongside confidence.            â•‘
  â•‘  10. Forecast CSV download added.                             â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  DEPLOY TO GITHUB PAGES:
    1. Create a new repo (e.g. paragon-analytics)
    2. Add this file as index.html at repo root
    3. Settings â†’ Pages â†’ Branch: main / (root)
    4. Live at: https://<you>.github.io/paragon-analytics/

  No build step. No npm. No server. Pure static HTML.
-->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Paragon Analytics â€” Executive Forecasting</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg:      #08090d;
      --surface: #0f1118;
      --border:  #1e2230;
      --accent:  #c9a84c;
      --accent2: #4c8ec9;
      --green:   #22c55e;
      --amber:   #f59e0b;
      --red:     #ef4444;
      --text:    #e8e9ef;
      --muted:   #6b7280;
      --card-bg: #11131c;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
      opacity: 0.6;
    }

    /* â”€â”€ HEADER â”€â”€ */
    header {
      position: relative; z-index: 10;
      display: flex; align-items: center; justify-content: space-between;
      padding: 1.2rem 2.5rem;
      border-bottom: 1px solid var(--border);
      background: rgba(8,9,13,0.92);
      backdrop-filter: blur(12px);
    }
    .logo { display: flex; align-items: baseline; gap: 0.5rem; }
    .logo-name {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem; font-weight: 700;
      color: var(--text); letter-spacing: -0.02em;
    }
    .logo-badge {
      font-family: 'DM Mono', monospace;
      font-size: 0.65rem; font-weight: 500;
      color: var(--accent); border: 1px solid var(--accent);
      padding: 1px 6px; border-radius: 3px;
      letter-spacing: 0.08em; text-transform: uppercase;
    }
    .header-right {
      display: flex; align-items: center; gap: 1rem;
      font-family: 'DM Mono', monospace;
      font-size: 0.72rem; color: var(--muted); letter-spacing: 0.05em;
    }
    #clock { color: var(--accent); }
    .btn-sample {
      display: inline-flex; align-items: center; gap: 0.4rem;
      padding: 0.35rem 0.9rem;
      border: 1px solid var(--accent2); border-radius: 5px;
      background: rgba(76,142,201,0.08);
      color: var(--accent2);
      font-family: 'DM Mono', monospace;
      font-size: 0.7rem; cursor: pointer;
      transition: all 0.18s; letter-spacing: 0.05em;
    }
    .btn-sample:hover { background: rgba(76,142,201,0.18); }

    /* â”€â”€ MAIN LAYOUT â”€â”€ */
    main {
      position: relative; z-index: 1;
      max-width: 1200px; margin: 0 auto;
      padding: 2rem 2rem 4rem;
      display: flex; flex-direction: column; gap: 1.5rem;
    }

    /* â”€â”€ CARD â”€â”€ */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 10px; padding: 1.5rem;
      transition: border-color 0.2s;
    }
    .card:hover { border-color: #2a2f45; }
    .card-title {
      font-family: 'DM Mono', monospace;
      font-size: 0.68rem; font-weight: 500;
      color: var(--muted); letter-spacing: 0.12em;
      text-transform: uppercase; margin-bottom: 1rem;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .card-title::before {
      content: ''; display: inline-block;
      width: 6px; height: 6px;
      background: var(--accent); border-radius: 50%;
    }

    /* â”€â”€ CONTROLS â”€â”€ */
    .controls-grid {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 0.75rem; align-items: center;
    }
    .controls-row2 {
      display: flex; gap: 0.75rem; align-items: center;
      margin-top: 0.75rem; flex-wrap: wrap;
    }
    .upload-zone {
      border: 1.5px dashed var(--border);
      border-radius: 8px; padding: 1.2rem 1.5rem;
      display: flex; align-items: center; gap: 1rem;
      cursor: pointer; transition: all 0.2s;
      background: rgba(201,168,76,0.03);
    }
    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--accent); background: rgba(201,168,76,0.07);
    }
    .upload-icon { font-size: 1.5rem; }
    .upload-text { font-size: 0.85rem; color: var(--muted); }
    .upload-text strong { color: var(--text); display: block; font-size: 0.9rem; }
    #csvFile { display: none; }

    .select-wrap { position: relative; }
    select {
      appearance: none;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 6px; padding: 0.6rem 2.5rem 0.6rem 1rem;
      color: var(--text); font-family: 'DM Sans', sans-serif;
      font-size: 0.88rem; cursor: pointer;
      transition: border-color 0.2s; min-width: 160px;
    }
    select:focus { outline: none; border-color: var(--accent); }
    .select-wrap::after {
      content: 'â–¾'; position: absolute; right: 0.75rem;
      top: 50%; transform: translateY(-50%);
      color: var(--muted); pointer-events: none; font-size: 0.8rem;
    }

    .label-sm {
      font-family: 'DM Mono', monospace; font-size: 0.68rem;
      color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase;
      display: block; margin-bottom: 0.25rem;
    }

    input[type="range"] {
      -webkit-appearance: none;
      height: 4px; border-radius: 2px;
      background: var(--border); cursor: pointer; vertical-align: middle;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px; height: 14px; border-radius: 50%;
      background: var(--accent); cursor: pointer;
    }

    .btn {
      display: inline-flex; align-items: center; gap: 0.5rem;
      padding: 0.6rem 1.4rem; border: none; border-radius: 6px;
      font-family: 'DM Sans', sans-serif; font-size: 0.88rem;
      font-weight: 500; cursor: pointer; transition: all 0.18s; white-space: nowrap;
    }
    .btn-primary { background: var(--accent); color: #08090d; }
    .btn-primary:hover { background: #dab85a; transform: translateY(-1px); }
    .btn-secondary {
      background: transparent; color: var(--muted); border: 1px solid var(--border);
    }
    .btn-secondary:hover { border-color: var(--accent2); color: var(--accent2); }
    .btn-ghost {
      background: transparent; color: var(--muted); border: 1px solid var(--border);
      font-size: 0.82rem; padding: 0.5rem 1rem;
    }
    .btn-ghost:hover { border-color: var(--green); color: var(--green); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

    /* â”€â”€ DATA PREVIEW â”€â”€ */
    .preview-table-wrap {
      overflow-x: auto; max-height: 180px; overflow-y: auto;
      border: 1px solid var(--border); border-radius: 6px; margin-top: 0.75rem;
    }
    .preview-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
    .preview-table th {
      background: var(--surface); position: sticky; top: 0;
      font-family: 'DM Mono', monospace; font-size: 0.65rem;
      color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em;
      padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border);
      text-align: left; white-space: nowrap;
    }
    .preview-table td {
      padding: 0.4rem 0.75rem; border-bottom: 1px solid rgba(30,34,48,0.5);
      color: var(--text); white-space: nowrap; font-family: 'DM Mono', monospace;
    }
    .preview-table tr:last-child td { border-bottom: none; }
    .preview-table tr:hover td { background: rgba(201,168,76,0.04); }
    .col-numeric { color: var(--accent) !important; }
    .col-date   { color: var(--accent2) !important; }

    /* â”€â”€ KPI ROW â”€â”€ */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
    }
    .kpi-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 8px; padding: 1.1rem 1.3rem;
      position: relative; overflow: hidden;
    }
    .kpi-card::after {
      content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px;
    }
    .kpi-card.green::after { background: var(--green); }
    .kpi-card.amber::after { background: var(--amber); }
    .kpi-card.red::after   { background: var(--red); }
    .kpi-card.blue::after  { background: var(--accent2); }
    .kpi-label {
      font-family: 'DM Mono', monospace; font-size: 0.62rem; color: var(--muted);
      text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.4rem;
    }
    .kpi-value {
      font-size: 1.6rem; font-weight: 300;
      font-family: 'Playfair Display', serif; line-height: 1;
    }
    .kpi-sub { font-family: 'DM Mono', monospace; font-size: 0.7rem; margin-top: 0.3rem; }
    .kpi-sub.green { color: var(--green); }
    .kpi-sub.amber { color: var(--amber); }
    .kpi-sub.red   { color: var(--red); }

    /* â”€â”€ CHART â”€â”€ */
    .chart-wrap { position: relative; height: 360px; }
    #trendChart { width: 100% !important; height: 100% !important; }

    /* â”€â”€ SCENARIO GRID (3 periods Ã— 3 scenarios) â”€â”€ */
    .scenario-header {
      display: grid; grid-template-columns: 1.2fr repeat(3, 1fr);
      gap: 0.5rem; margin-bottom: 0.4rem; padding: 0 0.25rem;
    }
    .scenario-header-cell {
      font-family: 'DM Mono', monospace; font-size: 0.62rem;
      color: var(--muted); text-align: center;
      text-transform: uppercase; letter-spacing: 0.08em;
    }
    .scenario-rows { display: flex; flex-direction: column; gap: 0.5rem; }
    .scenario-row { display: grid; grid-template-columns: 1.2fr repeat(3, 1fr); gap: 0.5rem; }
    .scenario-label-cell {
      display: flex; align-items: center;
      font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--muted);
      border: 1px solid var(--border); border-radius: 6px; padding: 0.6rem 0.8rem;
      background: var(--surface);
    }
    .scenario-value-cell {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 6px; padding: 0.6rem; text-align: center;
    }
    .scenario-value-cell .val {
      font-family: 'Playfair Display', serif; font-size: 1.05rem; line-height: 1;
    }
    .scenario-value-cell .delta {
      font-family: 'DM Mono', monospace; font-size: 0.6rem;
      color: var(--muted); margin-top: 0.25rem;
    }
    .scenario-row.opt .val { color: var(--green); }
    .scenario-row.base .val { color: var(--accent); }
    .scenario-row.pess .val { color: var(--red); }

    /* â”€â”€ LOG â”€â”€ */
    #logOutput {
      font-family: 'DM Mono', monospace; font-size: 0.75rem;
      color: var(--muted); line-height: 1.7; white-space: pre-wrap;
    }
    #logOutput .log-ok   { color: var(--green); }
    #logOutput .log-warn { color: var(--amber); }
    #logOutput .log-info { color: var(--accent2); }

    /* â”€â”€ HIDDEN / UTILITY â”€â”€ */
    .hidden { display: none !important; }
    .section-divider {
      display: flex; align-items: center; gap: 1rem;
      color: var(--muted); font-family: 'DM Mono', monospace;
      font-size: 0.68rem; letter-spacing: 0.1em;
    }
    .section-divider::before, .section-divider::after {
      content: ''; flex: 1; height: 1px; background: var(--border);
    }

    /* â”€â”€ TOAST â”€â”€ */
    #toast {
      position: fixed; bottom: 2rem; right: 2rem; z-index: 999;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 8px; padding: 0.8rem 1.4rem; font-size: 0.85rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      transform: translateY(20px); opacity: 0;
      transition: all 0.3s; pointer-events: none;
    }
    #toast.show { transform: translateY(0); opacity: 1; }
    #toast.err  { border-color: var(--red); color: var(--red); }

    /* â”€â”€ ANIMATIONS â”€â”€ */
    @keyframes fadeSlide {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .animate-in { animation: fadeSlide 0.4s ease both; }
    .delay-1 { animation-delay: 0.08s; }
    .delay-2 { animation-delay: 0.16s; }
    .delay-3 { animation-delay: 0.24s; }

    /* â”€â”€ RESPONSIVE â”€â”€ */
    @media (max-width: 768px) {
      header { padding: 1rem 1.2rem; flex-wrap: wrap; gap: 0.5rem; }
      main { padding: 1rem 1rem 3rem; }
      .controls-grid { grid-template-columns: 1fr; }
      .scenario-header, .scenario-row { grid-template-columns: 1fr 1fr 1fr; }
      .scenario-label-cell { display: none; }
      .scenario-header-cell:first-child { display: none; }
    }

    /* â”€â”€ HIDDEN CANVAS for PDF chart rendering â”€â”€ */
    #pdfChartCanvas { display: none; position: absolute; left: -9999px; }
  </style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <span class="logo-name">Paragon</span>
    <span class="logo-badge">Analytics</span>
  </div>
  <div class="header-right">
    <button class="btn-sample" onclick="loadSampleData()" title="Load built-in demo dataset">
      âš¡ Load Sample Data
    </button>
    Executive Forecasting &nbsp;|&nbsp; <span id="clock"></span>
  </div>
</header>

<!-- MAIN -->
<main>

  <!-- CONTROLS CARD -->
  <div class="card animate-in">
    <div class="card-title">Data Input &amp; Configuration</div>
    <div class="controls-grid">
      <div class="upload-zone" id="uploadZone" onclick="document.getElementById('csvFile').click()">
        <div class="upload-icon">ğŸ“‚</div>
        <div class="upload-text">
          <strong id="fileName">Upload CSV / TSV File</strong>
          Drag &amp; drop or click to browse
        </div>
        <input type="file" id="csvFile" accept=".csv,.tsv,.txt" />
      </div>
      <div class="select-wrap">
        <select id="metricSelect">
          <option value="">â€” Select Metric â€”</option>
        </select>
      </div>
      <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
        <button class="btn btn-primary" id="analyzeBtn" disabled>â–¶ Analyze</button>
        <button class="btn btn-secondary" id="pdfBtn" disabled>â¬‡ Export PDF</button>
        <button class="btn btn-ghost" id="csvExportBtn" disabled>â¬‡ CSV</button>
      </div>
    </div>
    <!-- ADVANCED SETTINGS ROW -->
    <div class="controls-row2">
      <div>
        <span class="label-sm">EMA Smoothing (Î±)</span>
        <div style="display:flex; align-items:center; gap:0.5rem;">
          <input type="range" id="alphaRange" min="0.05" max="0.6" step="0.05" value="0.3" style="width:100px">
          <span id="alphaVal" style="font-family:'DM Mono',monospace; font-size:0.75rem; color:var(--accent);">0.30</span>
        </div>
      </div>
      <div>
        <span class="label-sm">Forecast Periods</span>
        <div style="display:flex; align-items:center; gap:0.5rem;">
          <input type="range" id="horizonRange" min="1" max="8" step="1" value="3" style="width:100px">
          <span id="horizonVal" style="font-family:'DM Mono',monospace; font-size:0.75rem; color:var(--accent);">3</span>
        </div>
      </div>
      <div id="dateColWrap" class="hidden">
        <span class="label-sm">Date / Label Column</span>
        <div class="select-wrap">
          <select id="dateSelect" style="min-width:130px;">
            <option value="">â€” None â€”</option>
          </select>
        </div>
      </div>
    </div>
    <!-- DATA PREVIEW -->
    <div id="previewWrap" class="hidden">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:1rem; margin-bottom:0.3rem;">
        <span style="font-family:'DM Mono',monospace; font-size:0.65rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.1em;">Data Preview â€” first 6 rows</span>
        <span id="previewStats" style="font-family:'DM Mono',monospace; font-size:0.65rem; color:var(--muted);"></span>
      </div>
      <div class="preview-table-wrap">
        <table class="preview-table" id="previewTable"></table>
      </div>
    </div>
  </div>

  <!-- KPI ROW -->
  <div id="kpiSection" class="hidden animate-in delay-1">
    <div class="card-title" style="margin-bottom:0.75rem;">Business Summary</div>
    <div class="kpi-grid" id="kpiGrid"></div>
  </div>

  <!-- CHART CARD -->
  <div id="chartSection" class="card hidden animate-in delay-2">
    <div class="card-title">Trend &amp; Forecast</div>
    <div class="chart-wrap">
      <canvas id="trendChart"></canvas>
    </div>
  </div>

  <!-- SCENARIO SECTION (full 3Ã—3 grid, all periods visible) -->
  <div id="scenarioSection" class="hidden animate-in delay-3">
    <div class="section-divider" id="scenarioDivider">Scenario Analysis</div>
    <div style="margin-top:0.75rem;">
      <div class="scenario-header" id="scenarioHeader">
        <div class="scenario-header-cell"></div>
        <!-- Period labels injected by JS -->
      </div>
      <div class="scenario-rows" id="scenarioRows"></div>
    </div>
  </div>

  <!-- LOG CARD -->
  <div id="logSection" class="card hidden">
    <div class="card-title">Analysis Log</div>
    <pre id="logOutput"></pre>
  </div>

</main>

<!-- TOAST -->
<div id="toast"></div>

<!-- HIDDEN PDF CHART CANVAS â€” jsPDF renders a light-theme chart here -->
<canvas id="pdfChartCanvas"></canvas>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tick() {
  document.getElementById('clock').textContent =
    new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}
tick(); setInterval(tick, 1000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let rows = [], headers = [], numericCols = [], dateCols = [];
let metric = null, dateCol = null;
let chartObj = null, lastAnalysis = null;
let alpha = 0.3, horizon = 3;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ELEMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $ = id => document.getElementById(id);
const csvFile      = $('csvFile');
const analyzeBtn   = $('analyzeBtn');
const pdfBtn       = $('pdfBtn');
const csvExportBtn = $('csvExportBtn');
const metricSelect = $('metricSelect');
const dateSelect   = $('dateSelect');
const uploadZone   = $('uploadZone');
const fileName     = $('fileName');
const alphaRange   = $('alphaRange');
const horizonRange = $('horizonRange');
const alphaVal     = $('alphaVal');
const horizonVal   = $('horizonVal');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
alphaRange.addEventListener('input', () => {
  alpha = +alphaRange.value;
  alphaVal.textContent = alpha.toFixed(2);
  if (metric) analyze();
});
horizonRange.addEventListener('input', () => {
  horizon = +horizonRange.value;
  horizonVal.textContent = horizon;
  if (metric) analyze();
});
metricSelect.addEventListener('change', () => {
  metric = metricSelect.value;
  if (metric) analyze();
});
dateSelect.addEventListener('change', () => {
  dateCol = dateSelect.value || null;
  if (metric) analyze();
});
analyzeBtn.addEventListener('click', () => analyze());
pdfBtn.addEventListener('click', () => exportPDF());
csvExportBtn.addEventListener('click', () => exportForecastCSV());

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG & DROP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
uploadZone.addEventListener('dragover', e => {
  e.preventDefault(); uploadZone.classList.add('dragover');
});
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault(); uploadZone.classList.remove('dragover');
  const f = e.dataTransfer.files[0];
  if (f) readFile(f);
});
csvFile.addEventListener('change', () => { if (csvFile.files[0]) readFile(csvFile.files[0]); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAMPLE DATA â€” FIX: users can immediately test without a file
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadSampleData() {
  const csv = `date,revenue,units_sold,avg_order_value,customer_count
2023-01,142500,1420,100.35,1050
2023-02,138900,1380,100.65,1030
2023-03,151200,1490,101.48,1120
2023-04,163400,1600,102.13,1200
2023-05,171000,1660,103.01,1250
2023-06,168700,1630,103.50,1230
2023-07,175300,1690,103.73,1270
2023-08,180100,1730,104.10,1310
2023-09,188400,1800,104.67,1360
2023-10,195700,1860,105.22,1400
2023-11,214300,2020,106.09,1540
2023-12,231800,2180,106.33,1680
2024-01,198400,1870,106.10,1430
2024-02,195200,1840,106.09,1420
2024-03,210500,1970,106.85,1510
2024-04,221800,2060,107.67,1590
2024-05,229300,2120,108.16,1640
2024-06,234700,2160,108.66,1670
2024-07,241100,2210,109.09,1710
2024-08,249800,2280,109.56,1760
2024-09,258400,2350,109.96,1810
2024-10,267900,2430,110.25,1870
2024-11,291200,2640,110.30,2050
2024-12,318500,2880,110.59,2240`;
  fileName.textContent = 'sample_business_data.csv';
  parse(csv);
  toast('âœ“ Sample dataset loaded â€” 24 months of business data');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE READ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function readFile(file) {
  fileName.textContent = file.name;
  const r = new FileReader();
  r.onload = e => parse(e.target.result);
  r.readAsText(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSE â€” FIX: handles quoted CSV fields correctly
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseCSVLine(line, delim) {
  // Handles "field,with,commas" and "field with ""quotes"""
  const fields = [];
  let cur = '', inQ = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') {
      if (inQ && line[i+1] === '"') { cur += '"'; i++; }
      else inQ = !inQ;
    } else if (c === delim && !inQ) {
      fields.push(cur.trim()); cur = '';
    } else {
      cur += c;
    }
  }
  fields.push(cur.trim());
  return fields;
}

function isDateLike(val) {
  if (typeof val !== 'string') return false;
  return /^\d{4}[-/]\d{1,2}([-/]\d{1,2})?$/.test(val) ||
         /^Q[1-4]\s*\d{4}$/i.test(val) ||
         /^\d{1,2}[-/]\d{4}$/.test(val) ||
         /^\d{4}$/.test(val);
}

function parse(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  const delim = [',', ';', '\t', '|'].find(x => {
    const parts = parseCSVLine(lines[0], x);
    return parts.length > 1;
  }) || ',';

  headers = parseCSVLine(lines[0], delim).map(h =>
    h.replace(/^["']|["']$/g,'').toLowerCase().replace(/\W+/g,'_')
  );

  rows = lines.slice(1).map(l => {
    const p = parseCSVLine(l, delim);
    const o = {};
    headers.forEach((h, i) => {
      const raw = (p[i] || '').replace(/^["']|["']$/g,'').trim();
      o[h] = (!isNaN(+raw) && raw !== '') ? +raw : raw;
    });
    return o;
  }).filter(r => headers.some(h => typeof r[h] === 'number'));

  numericCols = headers.filter(h => rows.some(r => typeof r[h] === 'number'));
  // FIX: detect date/label columns for X-axis
  dateCols = headers.filter(h =>
    !numericCols.includes(h) || rows.slice(0,5).some(r => isDateLike(String(r[h])))
  );

  // Populate metric selector
  metricSelect.innerHTML = '<option value="">â€” Select Metric â€”</option>' +
    numericCols.map(c => `<option value="${c}">${c.replace(/_/g,' ')}</option>`).join('');

  // Populate date/label selector
  const dcWrap = $('dateColWrap');
  if (dateCols.length) {
    dcWrap.classList.remove('hidden');
    dateSelect.innerHTML = '<option value="">â€” None â€”</option>' +
      dateCols.map(c => `<option value="${c}">${c.replace(/_/g,' ')}</option>`).join('');
    // Auto-select if obvious
    const auto = dateCols.find(c => /date|period|month|year|week|quarter/i.test(c));
    if (auto) { dateSelect.value = auto; dateCol = auto; }
  } else {
    dcWrap.classList.add('hidden'); dateCol = null;
  }

  // Build data preview table
  buildPreview();

  metric = numericCols[0] || null;
  if (metric) { metricSelect.value = metric; analyze(); }
  analyzeBtn.disabled = false;

  $('previewStats').textContent = `${rows.length} rows Â· ${numericCols.length} numeric Â· ${dateCols.length} date`;
  $('previewWrap').classList.remove('hidden');
}

function buildPreview() {
  const t = $('previewTable');
  const show = rows.slice(0, 6);
  t.innerHTML =
    `<thead><tr>${headers.map(h => {
      const cls = numericCols.includes(h) ? 'col-numeric' :
                  dateCols.includes(h) ? 'col-date' : '';
      return `<th class="${cls}">${h.replace(/_/g,' ')}</th>`;
    }).join('')}</tr></thead>` +
    `<tbody>${show.map(r =>
      `<tr>${headers.map(h => {
        const cls = numericCols.includes(h) ? 'col-numeric' :
                    dateCols.includes(h) ? 'col-date' : '';
        return `<td class="${cls}">${r[h] !== undefined ? r[h] : ''}</td>`;
      }).join('')}</tr>`
    ).join('')}</tbody>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function analyze() {
  if (!metric) return;
  const s = rows.map(r => r[metric]).filter(v => typeof v === 'number');
  if (s.length < 4) { toast('Need at least 4 numeric data points', true); return; }

  const labels = dateCol
    ? rows.map(r => String(r[dateCol]))
    : s.map((_, i) => `P${i + 1}`);

  // MATH
  const avg  = mean(s);
  const sigma = std(s);
  const vol  = sigma / Math.abs(avg);
  const smooth = ema(s, alpha);

  // FIX: Use RECENT tail (last ~25%, min 3 pts) for slope, not global firstâ†’last.
  // This prevents old growth regimes from distorting near-term forecasts.
  const tailLen = Math.max(3, Math.round(smooth.length * 0.25));
  const tail = smooth.slice(-tailLen);
  const slope = (tail[tail.length - 1] - tail[0]) / (tail.length - 1);

  // FIX: RÂ² of EMA fit to actual data â€” real goodness-of-fit metric
  const ssTot = s.reduce((acc, v) => acc + (v - avg) ** 2, 0);
  const ssRes = s.reduce((acc, v, i) => acc + (v - smooth[i]) ** 2, 0);
  const r2 = ssTot > 0 ? Math.max(0, 1 - ssRes / ssTot) : 0;

  // FIX: Confidence now based on RÂ² + sample size penalty (not arbitrary formula)
  const sampleFactor = Math.min(1, Math.log(s.length + 1) / Math.log(30));
  const rawConf = r2 * 70 + sampleFactor * 25;
  const conf = Math.round(Math.max(10, Math.min(95, rawConf)));
  const badge = conf > 72 ? 'green' : conf > 50 ? 'amber' : 'red';

  const lastActual = s[s.length - 1];
  const lastEma    = smooth[smooth.length - 1];
  const base = forecast(lastEma, slope, horizon);
  const opt  = base.map(v => v + sigma);
  const pess = base.map(v => v - sigma);

  const trendDir = slope >  0.001 * avg ? 'â†‘ Upward'
                 : slope < -0.001 * avg ? 'â†“ Downward' : 'â†’ Flat';
  const trendColor = slope > 0.001 * avg ? 'var(--green)'
                   : slope < -0.001 * avg ? 'var(--red)' : 'var(--amber)';
  const pctChange = lastActual !== 0
    ? ((base[0] - lastActual) / Math.abs(lastActual) * 100).toFixed(1) : 'â€“';
  const pctSign = parseFloat(pctChange) >= 0 ? '+' : '';

  lastAnalysis = { metric, s, smooth, labels, base, opt, pess, avg, sigma, vol,
                   slope, conf, badge, r2, trendDir, pctChange, pctSign };

  // â”€â”€ KPIs â”€â”€
  $('kpiGrid').innerHTML = `
    <div class="kpi-card blue">
      <div class="kpi-label">Metric</div>
      <div class="kpi-value" style="font-size:1.05rem; padding-top:0.3rem;">${metric.replace(/_/g,' ')}</div>
      <div class="kpi-sub" style="color:var(--muted)">${s.length} data points</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Average</div>
      <div class="kpi-value">${fmtNum(avg)}</div>
      <div class="kpi-sub" style="color:var(--muted)">Ïƒ = ${fmtNum(sigma)}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Trend Direction</div>
      <div class="kpi-value" style="font-size:1.15rem; padding-top:0.2rem; color:${trendColor}">${trendDir}</div>
      <div class="kpi-sub" style="color:var(--muted)">Next period: ${pctSign}${pctChange}%</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Volatility</div>
      <div class="kpi-value">${(vol*100).toFixed(1)}%</div>
      <div class="kpi-sub" style="color:var(--muted)">Coeff. of variation</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">RÂ² Fit</div>
      <div class="kpi-value">${r2.toFixed(3)}</div>
      <div class="kpi-sub" style="color:var(--muted)">EMA goodness-of-fit</div>
    </div>
    <div class="kpi-card ${badge}">
      <div class="kpi-label">Confidence</div>
      <div class="kpi-value">${conf}%</div>
      <div class="kpi-sub ${badge}">${badge==='green'?'â— High':badge==='amber'?'â— Moderate':'â— Low'} confidence</div>
    </div>
  `;

  // â”€â”€ FIX: Full 3-period scenario table visible in main UI â”€â”€
  const fcstPeriodLabels = Array.from({length: horizon}, (_, i) => {
    if (dateCol && labels.length >= s.length) return `F${i+1}`;
    return `Period +${i+1}`;
  });
  $('scenarioDivider').textContent = `Scenario Analysis â€” ${horizon}-Period Outlook`;
  $('scenarioHeader').innerHTML =
    `<div class="scenario-header-cell"></div>` +
    fcstPeriodLabels.map(l => `<div class="scenario-header-cell">${l}</div>`).join('');

  const makeDelta = (v, ref) => {
    const d = ((v - ref) / Math.abs(ref) * 100).toFixed(1);
    return `${d >= 0 ? '+' : ''}${d}%`;
  };

  $('scenarioRows').innerHTML = [
    { cls:'opt',  label:'â–² Optimistic', vals: opt },
    { cls:'base', label:'â—† Base',       vals: base },
    { cls:'pess', label:'â–¼ Pessimistic',vals: pess },
  ].map(row =>
    `<div class="scenario-row ${row.cls}">
      <div class="scenario-label-cell">${row.label}</div>
      ${row.vals.map((v, i) =>
        `<div class="scenario-value-cell">
          <div class="val">${fmtNum(v)}</div>
          <div class="delta">${makeDelta(v, lastActual)}</div>
        </div>`
      ).join('')}
    </div>`
  ).join('');

  // â”€â”€ LOG â”€â”€
  const ts = new Date().toLocaleTimeString();
  $('logOutput').innerHTML =
    `<span class="log-ok">[${ts}] âœ“ Analysis complete Â· EMA Î±=${alpha} Â· horizon=${horizon}</span>\n` +
    `<span class="log-info">[INFO] Metric      : ${metric}</span>\n` +
    `<span class="log-info">[INFO] Data points : ${s.length} (tail for slope: last ${tailLen})</span>\n` +
    `<span class="log-info">[INFO] Average     : ${avg.toFixed(4)}</span>\n` +
    `<span class="log-info">[INFO] Std Dev     : ${sigma.toFixed(4)}</span>\n` +
    `<span class="log-info">[INFO] Volatility  : ${(vol*100).toFixed(2)}%</span>\n` +
    `<span class="log-info">[INFO] EMA Slope   : ${slope.toFixed(6)} (recent tail)</span>\n` +
    `<span class="log-info">[INFO] RÂ² fit      : ${r2.toFixed(4)}</span>\n` +
    `<span class="log-info">[INFO] Î” Next per  : ${pctSign}${pctChange}%</span>\n` +
    `<span class="log-${badge}">[CONF] Score       : ${conf}% (${badge.toUpperCase()})</span>\n` +
    base.map((v, i) =>
      `<span class="log-info">[FCST] Base[+${i+1}]   : ${v.toFixed(4)}</span>`
    ).join('\n') + '\n' +
    `<span class="log-ok">[FCST] Opt [+1]   : ${opt[0].toFixed(4)}</span>\n` +
    `<span class="log-warn">[FCST] Pess[+1]   : ${pess[0].toFixed(4)}</span>`;

  // Show sections
  [$('kpiSection'), $('chartSection'), $('scenarioSection'), $('logSection')]
    .forEach(el => el.classList.remove('hidden'));
  pdfBtn.disabled = false;
  csvExportBtn.disabled = false;

  renderChart(s, smooth, base, opt, pess, labels);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildChartConfig(s, t, b, o, p, labels, theme='dark') {
  const isDark = theme === 'dark';
  const gridColor  = isDark ? 'rgba(30,34,48,0.8)' : 'rgba(200,200,210,0.5)';
  const tickColor  = isDark ? '#6b7280' : '#555';
  const ttBg       = isDark ? '#11131c' : '#fff';
  const ttBorder   = isDark ? '#1e2230' : '#ccc';
  const ttTitle    = isDark ? '#e8e9ef' : '#111';
  const ttBody     = isDark ? '#6b7280' : '#444';
  const legendColor = isDark ? '#6b7280' : '#555';

  const fullLabels = [...labels.slice(0, s.length), ...b.map((_, i) => `F${i+1}`)];

  return {
    type: 'line',
    data: {
      labels: fullLabels,
      datasets: [
        {
          label: 'Actual',
          data: s,
          borderColor: '#c9a84c',
          backgroundColor: 'rgba(201,168,76,0.08)',
          borderWidth: 2, tension: 0.3,
          pointRadius: 3, pointBackgroundColor: '#c9a84c', fill: true,
        },
        {
          label: 'EMA',
          data: t,
          borderColor: '#4c8ec9', borderWidth: 1.5,
          borderDash: [4,4], tension: 0.4,
          pointRadius: 0, fill: false,
        },
        {
          label: 'Base Forecast',
          data: [...Array(s.length).fill(null), ...b],
          borderColor: '#c9a84c', borderWidth: 2, borderDash: [6,6],
          pointRadius: 4, pointBackgroundColor: '#c9a84c', fill: false,
        },
        {
          label: 'Upper (Opt.)',
          data: [...Array(s.length).fill(null), ...o],
          borderColor: '#22c55e', borderWidth: 0,
          backgroundColor: 'rgba(34,197,94,0.12)',
          fill: '+1', pointRadius: 0,
        },
        {
          label: 'Lower (Pess.)',
          data: [...Array(s.length).fill(null), ...p],
          borderColor: '#ef4444', borderWidth: 0,
          fill: false, pointRadius: 0,
        },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode:'index', intersect: false },
      plugins: {
        legend: { labels: { color: legendColor, font: { family:'DM Mono', size:10 }, boxWidth:20 } },
        tooltip: {
          backgroundColor: ttBg, borderColor: ttBorder, borderWidth: 1,
          titleColor: ttTitle, bodyColor: ttBody,
          titleFont: { family:'DM Mono', size:11 }, bodyFont: { family:'DM Mono', size:10 },
        }
      },
      scales: {
        x: {
          grid: { color: gridColor },
          ticks: { color: tickColor, font:{family:'DM Mono',size:9}, maxTicksLimit:14 },
        },
        y: {
          grid: { color: gridColor },
          ticks: { color: tickColor, font:{family:'DM Mono',size:9} },
        }
      }
    }
  };
}

function renderChart(s, t, b, o, p, labels) {
  if (chartObj) { chartObj.destroy(); chartObj = null; }
  const ctx = $('trendChart').getContext('2d');
  chartObj = new Chart(ctx, buildChartConfig(s, t, b, o, p, labels, 'dark'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT FORECAST CSV â€” NEW FEATURE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportForecastCSV() {
  if (!lastAnalysis) return;
  const { metric, base, opt, pess, s } = lastAnalysis;
  const lines = ['period,scenario,value'];
  base.forEach((v, i) => {
    lines.push(`+${i+1},optimistic,${opt[i].toFixed(4)}`);
    lines.push(`+${i+1},base,${v.toFixed(4)}`);
    lines.push(`+${i+1},pessimistic,${pess[i].toFixed(4)}`);
  });
  const blob = new Blob([lines.join('\n')], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${metric}_forecast.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast('âœ“ Forecast CSV downloaded');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT PDF â€” uses jsPDF directly; no window.print(), no CSS tricks
// Builds and downloads a real .pdf file that works in every browser.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function exportPDF() {
  if (!lastAnalysis) return;
  if (!window.jspdf) { toast('PDF library not loaded yet â€” try again in a moment', true); return; }

  pdfBtn.disabled = true;
  pdfBtn.textContent = 'â³ Building PDFâ€¦';

  const { metric, s, smooth, labels, base, opt, pess, avg, sigma,
          slope, conf, r2, trendDir, pctChange, pctSign } = lastAnalysis;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

  // â”€â”€ A4 layout constants â”€â”€
  const PW = 210, PH = 297;
  const ML = 14, MR = 14, MT = 0;
  const CW = PW - ML - MR;  // content width = 182 mm
  let Y = MT;                // cursor Y position

  // â”€â”€ Colour helpers â”€â”€
  const hexToRgb = hex => {
    const r = parseInt(hex.slice(1,3),16);
    const g = parseInt(hex.slice(3,5),16);
    const b = parseInt(hex.slice(5,7),16);
    return [r, g, b];
  };
  const setFill   = hex => { const [r,g,b] = hexToRgb(hex); doc.setFillColor(r,g,b); };
  const setDraw   = hex => { const [r,g,b] = hexToRgb(hex); doc.setDrawColor(r,g,b); };
  const setTextC  = hex => { const [r,g,b] = hexToRgb(hex); doc.setTextColor(r,g,b); };
  const fillRect  = (x,y,w,h) => doc.rect(x, y, w, h, 'F');
  const drawRect  = (x,y,w,h) => doc.rect(x, y, w, h, 'S');

  const badgeHex  = conf > 72 ? '#15803d' : conf > 50 ? '#b45309' : '#b91c1c';
  const trendHex  = slope > 0 ? '#15803d' : slope < 0 ? '#b91c1c' : '#b45309';
  const badgeLabel= conf > 72 ? 'HIGH CONFIDENCE' : conf > 50 ? 'MODERATE CONFIDENCE' : 'LOW CONFIDENCE';
  const lastActual = s[s.length - 1];

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 1. HEADER BAR (dark background)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  setFill('#0d1117'); fillRect(0, 0, PW, 28);

  // Gold accent bar below header
  // Gradient approximated as two rects
  setFill('#c9a84c'); fillRect(0, 28, CW * 0.55, 2.5);
  setFill('#4c8ec9'); fillRect(ML + CW * 0.55, 28, CW * 0.45, 2.5);

  // Logo text
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(18);
  setTextC('#ffffff');
  doc.text('PARAGON', ML, 17);

  doc.setFont('helvetica', 'normal');
  doc.setFontSize(7);
  setTextC('#c9a84c');
  doc.text('ANALYTICS  Â·  EXECUTIVE FORECASTING REPORT', ML, 23);

  // Date top-right
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(7);
  setTextC('#9ca3af');
  const dateStr = new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
  doc.text('CONFIDENTIAL', PW - MR, 14, { align: 'right' });
  setTextC('#e5e7eb');
  doc.text(dateStr, PW - MR, 21, { align: 'right' });

  Y = 37;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 2. SUBJECT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(7);
  setTextC('#6b7280');
  doc.text('ANALYSIS SUBJECT', ML, Y);
  Y += 5;

  doc.setFont('helvetica', 'bold');
  doc.setFontSize(16);
  setTextC('#111111');
  const title = metric.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
  doc.text(title, ML, Y);
  Y += 5;

  doc.setFont('helvetica', 'normal');
  doc.setFontSize(7.5);
  setTextC('#6b7280');
  doc.text(`${s.length} historical data points  Â·  EMA Î± = ${alpha.toFixed(2)}  Â·  Horizon = ${horizon} periods`, ML, Y);
  Y += 3;

  // Divider line
  setDraw('#111111');
  doc.setLineWidth(0.5);
  doc.line(ML, Y, PW - MR, Y);
  Y += 6;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3. KPI BOXES (5 across)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const kpis = [
    { label: 'AVERAGE',    value: fmtNum(avg),       sub: 'Historical mean',     color: '#2563eb' },
    { label: 'STD DEV',    value: fmtNum(sigma),      sub: 'Volatility band Â±',   color: '#7c3aed' },
    { label: 'TREND',      value: trendDir,            sub: `Next: ${pctSign}${pctChange}%`, color: trendHex },
    { label: 'RÂ² FIT',     value: r2.toFixed(3),      sub: 'EMA goodness-of-fit', color: '#0891b2' },
    { label: 'CONFIDENCE', value: conf + '%',          sub: badgeLabel,            color: badgeHex  },
  ];

  const boxW = (CW - 4 * 2.5) / 5;  // 5 boxes with 2.5mm gaps
  const boxH = 22;

  kpis.forEach((k, i) => {
    const bx = ML + i * (boxW + 2.5);
    const by = Y;

    // Box background
    setFill('#f8fafc'); fillRect(bx, by, boxW, boxH);
    // Border
    setDraw('#e5e7eb'); doc.setLineWidth(0.3); drawRect(bx, by, boxW, boxH);
    // Top colour bar
    setFill(k.color); fillRect(bx, by, boxW, 1.5);

    // Label
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(5.5);
    setTextC('#64748b');
    doc.text(k.label, bx + boxW/2, by + 6, { align: 'center' });

    // Value
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(k.value.length > 9 ? 8 : 11);
    setTextC(k.color);
    doc.text(k.value, bx + boxW/2, by + 13, { align: 'center' });

    // Sub label
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(5);
    setTextC('#64748b');
    // Wrap if needed
    const subLines = doc.splitTextToSize(k.sub, boxW - 2);
    doc.text(subLines, bx + boxW/2, by + 18, { align: 'center' });
  });

  Y += boxH + 7;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 4. CHART IMAGE (light-theme re-render)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  try {
    const pdfCanvas = $('pdfChartCanvas');
    pdfCanvas.width  = 1100;
    pdfCanvas.height = 380;
    pdfCanvas.style.display = 'none';

    // Destroy any previous pdf chart
    if (window._pdfChartObj) { try { window._pdfChartObj.destroy(); } catch(e){} }

    window._pdfChartObj = new Chart(
      pdfCanvas.getContext('2d'),
      buildChartConfig(s, smooth, base, opt, pess, labels, 'light')
    );

    // Wait for Chart.js to finish rendering
    await new Promise(resolve => setTimeout(resolve, 120));

    const tmp = document.createElement('canvas');
    tmp.width = pdfCanvas.width; tmp.height = pdfCanvas.height;
    const ctx2 = tmp.getContext('2d');
    ctx2.fillStyle = '#ffffff';
    ctx2.fillRect(0, 0, tmp.width, tmp.height);
    ctx2.drawImage(pdfCanvas, 0, 0);
    const chartImg = tmp.toDataURL('image/png');

    window._pdfChartObj.destroy();
    window._pdfChartObj = null;

    // Section label
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(6.5);
    setTextC('#6b7280');
    doc.text('TREND & FORECAST CHART', ML, Y);
    Y += 3;

    // Chart border box
    setDraw('#e5e7eb'); doc.setLineWidth(0.3);
    const chartH = 58;
    drawRect(ML, Y, CW, chartH);
    doc.addImage(chartImg, 'PNG', ML + 1, Y + 1, CW - 2, chartH - 2);
    Y += chartH + 7;

  } catch(e) {
    // Chart capture failed silently â€” PDF continues without it
    console.warn('Chart capture failed:', e);
    Y += 4;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 5. SCENARIO TABLE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(6.5);
  setTextC('#6b7280');
  doc.text(`${horizon}-PERIOD SCENARIO FORECAST`, ML, Y);
  Y += 4;

  const scenarios = [
    { label: 'â–² Optimistic',  vals: opt,  bg: '#f0fdf4', color: '#15803d' },
    { label: 'â—† Base',         vals: base, bg: '#fffbeb', color: '#92400e' },
    { label: 'â–¼ Pessimistic',  vals: pess, bg: '#fef2f2', color: '#b91c1c' },
  ];

  const colW = CW / (horizon + 1);
  const rowH = 11;
  const tblX = ML;

  // Header row
  setFill('#0d1117'); fillRect(tblX, Y, CW, rowH);
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(6.5);
  setTextC('#ffffff');
  doc.text('SCENARIO', tblX + colW * 0.5, Y + 7, { align: 'center' });
  for (let i = 0; i < horizon; i++) {
    doc.text(`PERIOD +${i+1}`, tblX + colW * (i + 1) + colW * 0.5, Y + 7, { align: 'center' });
  }
  Y += rowH;

  // Data rows
  const borderColors = ['#bbf7d0', '#fde68a', '#fecaca'];
  scenarios.forEach((row, ri) => {
    setFill(row.bg); fillRect(tblX, Y, CW, rowH);
    setDraw(borderColors[ri]); doc.setLineWidth(0.2); drawRect(tblX, Y, CW, rowH);

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(7.5);
    setTextC(row.color);
    doc.text(row.label, tblX + colW * 0.5, Y + 7, { align: 'center' });

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(9);
    row.vals.forEach((v, i) => {
      doc.text(fmtNum(v), tblX + colW * (i + 1) + colW * 0.5, Y + 7.5, { align: 'center' });
    });

    Y += rowH;
  });

  Y += 8;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 6. FOOTER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  setDraw('#d1d5db'); doc.setLineWidth(0.3);
  doc.line(ML, Y, PW - MR, Y);
  Y += 4;

  doc.setFont('helvetica', 'normal');
  doc.setFontSize(6);
  setTextC('#9ca3af');
  doc.text('Paragon Analytics Â· Executive Forecasting Â· For internal use only', ML, Y);
  doc.text(`paragon.analytics Â· ${new Date().getFullYear()}`, PW - MR, Y, { align: 'right' });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SAVE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const safeName = metric.replace(/\W+/g, '_').toLowerCase();
  doc.save(`paragon_${safeName}_report.pdf`);

  pdfBtn.disabled = false;
  pdfBtn.textContent = 'â¬‡ Export PDF';
  toast('âœ“ PDF downloaded successfully');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, err=false) {
  const t = $('toast');
  t.textContent = msg;
  t.className = err ? 'show err' : 'show';
  clearTimeout(t._tid);
  t._tid = setTimeout(() => { t.className = ''; }, 3200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MATH HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mean(a) { return a.reduce((x,y) => x+y, 0) / a.length; }
function std(a) {
  const m = mean(a);
  return Math.sqrt(a.reduce((acc, v) => acc + (v-m)**2, 0) / a.length);
}
// FIX: correct EMA â€” Î±*current + (1-Î±)*previous
function ema(a, alpha) {
  const o = [a[0]];
  for (let i = 1; i < a.length; i++)
    o.push(alpha * a[i] + (1 - alpha) * o[i-1]);
  return o;
}
// FIX: additive linear projection from last EMA value + step * slope
function forecast(last, slope, n) {
  return Array.from({length: n}, (_, i) => +(last + slope * (i + 1)).toFixed(6));
}
// Smart number formatter
function fmtNum(v) {
  if (Math.abs(v) >= 1e6)  return (v/1e6).toFixed(2) + 'M';
  if (Math.abs(v) >= 1e3)  return (v/1e3).toFixed(1) + 'K';
  if (Math.abs(v) < 0.01 && v !== 0) return v.toExponential(2);
  return v.toFixed(2);
}
</script>
</body>
</html>
