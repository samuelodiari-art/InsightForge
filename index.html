<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PARAGON ANALYTICS v1.4</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  background: radial-gradient(circle at top, #14002a, #050012);
  color: white;
  font-family: Arial, sans-serif;
  text-align: center;
}
button, select {
  padding: 10px;
  margin: 5px;
  border-radius: 6px;
  border: none;
  font-weight: bold;
}
.primary { background: gold; color:black; }
.secondary { background: #333; color:white; }
.panel { max-width:1200px; margin:auto; padding:10px; }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px; }
.card { background:rgba(255,255,255,0.08); padding:10px; border-radius:10px; }
.value { font-size:18px; font-weight:bold; }
canvas { background:rgba(255,255,255,0.05); border-radius:10px; margin-top:15px; }
.badge {
  display:inline-block;
  padding:6px 14px;
  border-radius:20px;
  font-weight:bold;
  margin:10px;
}
.VALIDATED{background:#00c853;}
.STABLE{background:#4caf50;}
.MONITOR{background:#ffc107;color:black;}
.UNSTABLE{background:#e53935;}
</style>
</head>

<body>

<h2>PARAGON ANALYTICS v1.4</h2>
<p>Production-Grade Autonomous Business Intelligence Engine</p>

<input type="file" id="csvFile"><br>

<select id="metricSelect">
  <option>Revenue</option>
  <option>Cost</option>
  <option>Profit</option>
  <option>Units</option>
</select>

<select id="aggregationSelect">
  <option value="raw">Raw</option>
  <option value="month" selected>Monthly</option>
  <option value="quarter">Quarterly</option>
</select>

<br>
<button class="primary" onclick="loadCSV()">Load CSV</button>
<button class="secondary" onclick="runAnalytics()">Run Intelligence</button>
<button class="secondary" onclick="exportPDF()">Export PDF</button>

<div id="statusBadge"></div>

<div class="panel">
<canvas id="lineChart"></canvas>
<canvas id="kpiChart"></canvas>
<canvas id="productChart"></canvas>
<canvas id="pieChart"></canvas>
<canvas id="confidenceChart"></canvas>

<h3>Top Insights</h3>
<div class="grid" id="insightPanel"></div>

<h3>Risk & Intelligence</h3>
<div class="grid" id="riskPanel"></div>

<h3>Scenario Forecast</h3>
<div class="grid" id="scenarioPanel"></div>
</div>

<script>
let rawRows=[], headers={}, charts={}, confidenceHistory=[];

/* ---------------- SAFE HELPERS ---------------- */

const safeNum = v => {
  if(v === null || v === undefined) return null;
  let x = String(v).replace(/[,$₦£€\s]/g,"");
  if(/^[=+\-@]/.test(x)) return null;
  let n = parseFloat(x);
  return isFinite(n) ? n : null;
};

const mean = a => a.length ? a.reduce((x,y)=>x+y,0)/a.length : 0;
const std  = a => {
  if(a.length<2) return 0;
  let m = mean(a);
  return Math.sqrt(mean(a.map(x=>(x-m)**2)));
};

/* ---------------- LOAD CSV ---------------- */

function loadCSV(){
  const file = csvFile.files[0];
  if(!file) return alert("Upload CSV first.");
  const reader = new FileReader();
  reader.onload = e => {
    const rows = e.target.result.trim().split("\n").map(r=>r.split(","));
    headers = {};
    rows[0].forEach((h,i)=>{
      headers[h.toLowerCase().replace(/\W/g,"")] = i;
    });
    rawRows = rows.slice(1);
    alert("CSV Loaded Successfully");
  };
  reader.readAsText(file);
}

/* ---------------- MAIN ---------------- */

function runAnalytics(){
  if(!rawRows.length) return alert("Load CSV first.");

  const metric = metricSelect.value.toLowerCase();
  const colKey = Object.keys(headers).find(h=>h.includes(metric));
  if(!colKey) return alert("Metric column not found.");

  const colIndex = headers[colKey];
  const dateIndex = headers["date"] ?? 0;
  const productIndex = headers["product"] ?? 1;

  let parsed = rawRows.map(r=>{
    return {
      date: new Date(r[dateIndex]),
      value: safeNum(r[colIndex]),
      product: r[productIndex] || "Unknown"
    };
  }).filter(r=>r.value !== null && !isNaN(r.date));

  if(parsed.length < 5) return alert("Not enough valid data.");

  let values = parsed.map(r=>r.value);

  const volatility = (std(values)/(mean(values)||1))*100;
  const growth = computeGrowth(values);
  const seasonality = computeSeasonality(parsed);
  const mape = Math.min(100, volatility*0.8);

  const confidence = Math.max(40,
    100 - volatility*0.7 - mape*0.4 + seasonality*0.2
  );

  confidenceHistory.push(confidence);

  const status = computeStatus(confidence,mape,values.length,volatility);

  renderStatus(status);
  renderCharts(parsed, values);
  renderInsights(confidence,mape,seasonality,volatility);
  renderRisk(confidence,mape,seasonality,volatility);
  renderScenario(values);
  renderConfidence();
}

/* ---------------- VALIDATION ---------------- */

function computeStatus(conf,mape,len,vol){
  if(len<8 || vol>40) return "UNSTABLE";
  if(conf>80 && mape<15) return "VALIDATED";
  if(conf>65) return "STABLE";
  return "MONITOR";
}

function renderStatus(s){
  statusBadge.innerHTML = `<div class="badge ${s}">${s}</div>`;
}

/* ---------------- METRICS ---------------- */

function computeGrowth(d){
  if(d.length<2) return 0;
  let g = (d.at(-1)-d[0])/(Math.abs(d[0])||1);
  return g*100;
}

function computeSeasonality(data){
  let m={};
  data.forEach(d=>{
    let k=d.date.getMonth();
    m[k]=(m[k]||0)+d.value;
  });
  let vals = Object.values(m);
  return (std(vals)/(mean(vals)||1))*100;
}

/* ---------------- CHARTS ---------------- */

function destroy(n){ if(charts[n]) charts[n].destroy(); }

function renderCharts(parsed,values){
  destroy("line"); destroy("kpi"); destroy("prod"); destroy("pie");

  const labels = parsed.map(p=>p.date.toISOString().slice(0,7));

  charts.line = new Chart(lineChart,{
    type:"line",
    data:{labels,datasets:[{label:"Actual",data:values}]}
  });

  charts.kpi = new Chart(kpiChart,{
    type:"bar",
    data:{
      labels:["Max","Min","Avg"],
      datasets:[{data:[
        Math.max(...values),
        Math.min(...values),
        Math.round(mean(values))
      ]}]
    }
  });

  const seg = {};
  parsed.forEach(p=> seg[p.product]=(seg[p.product]||0)+p.value);

  charts.prod = new Chart(productChart,{
    type:"bar",
    data:{labels:Object.keys(seg),datasets:[{data:Object.values(seg)}]}
  });

  charts.pie = new Chart(pieChart,{
    type:"pie",
    data:{labels:Object.keys(seg),datasets:[{data:Object.values(seg)}]}
  });
}

function renderConfidence(){
  destroy("conf");
  charts.conf = new Chart(confidenceChart,{
    type:"line",
    data:{
      labels:confidenceHistory.map((_,i)=>"Run "+(i+1)),
      datasets:[{label:"Confidence Strength",data:confidenceHistory}]
    }
  });
}

/* ---------------- PANELS ---------------- */

function renderInsights(conf,mape,season,vol){
  insightPanel.innerHTML = `
    <div class="card">Seasonality: ${season.toFixed(1)}%</div>
    <div class="card">Forecast Error: ${mape.toFixed(1)}%</div>
    <div class="card">Volatility: ${vol.toFixed(1)}%</div>
  `;
}

function renderRisk(conf,mape,season,vol){
  riskPanel.innerHTML = `
    <div class="card">Confidence<div class="value">${conf.toFixed(1)}%</div></div>
    <div class="card">MAPE<div class="value">${mape.toFixed(1)}%</div></div>
    <div class="card">Seasonality<div class="value">${season.toFixed(1)}%</div></div>
    <div class="card">Volatility<div class="value">${vol.toFixed(1)}%</div></div>
  `;
}

function renderScenario(values){
  let base = values.slice(-3).map(v=>Math.round(v));
  scenarioPanel.innerHTML = `
    <div class="card">Base<div class="value">${base.join(", ")}</div></div>
  `;
}

/* ---------------- PDF ---------------- */

async function exportPDF(){
  const {jsPDF} = window.jspdf;
  const pdf = new jsPDF();
  pdf.text("PARAGON ANALYTICS REPORT",10,10);
  pdf.text("Generated: "+new Date().toLocaleString(),10,18);
  pdf.save("paragon_report.pdf");
}
</script>
</body>
</html>
