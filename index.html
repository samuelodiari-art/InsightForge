<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>InsightForge Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: system-ui, Arial;
  background:#020617;
  color:white;
  text-align:center;
  padding:14px;
}
h1 { color:#22c55e; }

input, select {
  padding:10px;
  border-radius:8px;
  border:none;
  margin:6px;
  font-size:14px;
}

button {
  padding:12px 18px;
  margin:6px;
  border-radius:10px;
  border:none;
  font-size:15px;
  cursor:pointer;
}

.run { background:#22c55e; color:black; }
.load { background:#0ea5e9; color:black; }
.report { background:#f59e0b; color:black; }

#output {
  background:#020617;
  padding:12px;
  border-radius:10px;
  margin-top:12px;
  text-align:left;
  font-size:13px;
}

.dashboard {
  background:rgba(255,255,255,0.06);
  padding:12px;
  border-radius:12px;
  margin-top:12px;
  text-align:left;
}

.stat { margin:5px 0; }

canvas {
  max-width:100%;
  margin-top:16px;
}
</style>
</head>

<body>

<h1>ðŸš€ InsightForge Pro</h1>
<p>Upload CSV â†’ Load â†’ Analyze â†’ Forecast</p>

<input type="file" id="fileInput" accept=".csv"><br>
<button class="load" onclick="loadCSV()">Load CSV</button><br>

<select id="columnSelect">
  <option value="">Select column...</option>
</select><br>

<button class="run" onclick="runAnalysis()">Run AI Analysis</button>
<button class="report" onclick="downloadReport()">Download Report</button>

<div id="output">Waiting for CSV...</div>

<canvas id="chart"></canvas>

<div id="dashboard" class="dashboard" style="display:none;">
  <h3>ðŸ“Š Live Insights</h3>
  <div class="stat" id="statAvg"></div>
  <div class="stat" id="statMin"></div>
  <div class="stat" id="statMax"></div>
  <div class="stat" id="statGrowth"></div>
  <div class="stat" id="statTrend"></div>
  <div class="stat" id="statForecast"></div>
  <div class="stat" id="statAnomaly"></div>
</div>

<script>
let csvRows = [];
let chartInstance = null;
let reportData = null;

// ================= CSV LOADER =================
function loadCSV() {
  const input = document.getElementById("fileInput");
  const file = input.files[0];

  if (!file) {
    alert("Please select a CSV file first.");
    return;
  }

  const reader = new FileReader();

  reader.onload = function (e) {
    const text = e.target.result.trim();
    csvRows = text.split("\n").map(r => r.split(","));
    const headers = csvRows[0];

    const dropdown = document.getElementById("columnSelect");
    dropdown.innerHTML = '<option value="">Select column...</option>';

    headers.forEach(h => {
      const opt = document.createElement("option");
      opt.value = h.trim();
      opt.textContent = h.trim();
      dropdown.appendChild(opt);
    });

    document.getElementById("output").innerHTML =
      "âœ… CSV Loaded<br>ðŸ“Š Columns: " + headers.join(", ");
  };

  reader.readAsText(file);
}

// ================= CORE ANALYSIS =================
function runAnalysis() {
  const column = document.getElementById("columnSelect").value;
  if (!column) return alert("Select a column first.");

  const headers = csvRows[0].map(h => h.trim());
  const colIndex = headers.indexOf(column);
  if (colIndex === -1) return alert("Column not found.");

  let labels = [];
  let values = [];

  for (let i = 1; i < csvRows.length; i++) {
    labels.push("Row " + i);
    let raw = (csvRows[i][colIndex] || "").replace(/[^0-9.-]/g,"");
    const num = parseFloat(raw);
    values.push(isNaN(num) ? 0 : num);
  }

  if (values.length < 5) return alert("Dataset too small for forecasting.");

  // -------- Stats --------
  const avg = values.reduce((a,b)=>a+b,0)/values.length;
  const min = Math.min(...values);
  const max = Math.max(...values);
  const growth = ((values.at(-1)-values[0])/values[0])*100;
  const trendStrength = ((values.at(-1)-values.at(-2))/avg)*100;

  // -------- Forecast Engine --------
  const forecastSteps = 5;

  const smoothed = values.map((_,i,arr)=>{
    const start = Math.max(0,i-2);
    const slice = arr.slice(start,i+1);
    return slice.reduce((a,b)=>a+b,0)/slice.length;
  });

  const n = smoothed.length;
  const x = smoothed.map((_,i)=>i);
  const sumX = x.reduce((a,b)=>a+b,0);
  const sumY = smoothed.reduce((a,b)=>a+b,0);
  const sumXY = x.reduce((s,xi,i)=>s + xi*smoothed[i],0);
  const sumX2 = x.reduce((s,xi)=>s + xi*xi,0);

  const slope = (n*sumXY - sumX*sumY)/(n*sumX2 - sumX*sumX);
  const intercept = (sumY - slope*sumX)/n;

  let forecastValues = [...values];
  let forecastLabels = [...labels];

  for(let i=1;i<=forecastSteps;i++){
    const nextX = n + i;
    let pred = slope*nextX + intercept;

    const clamp = Math.abs(avg)*0.4;
    pred = Math.max(values.at(-1)-clamp, Math.min(values.at(-1)+clamp, pred));

    forecastValues.push(Math.round(pred));
    forecastLabels.push("F"+i);
  }

  // -------- Confidence --------
  const variance = values.reduce((a,b)=>a + Math.pow(b-avg,2),0)/values.length;
  const deviation = Math.sqrt(variance);

  const upper = forecastValues.map(v=>v + deviation);
  const lower = forecastValues.map(v=>v - deviation);

  // -------- Anomaly --------
  let anomalies=[];
  values.forEach((v,i)=>{
    if(v>avg+2*deviation) anomalies.push("Spike at row "+(i+1));
    if(v<avg-2*deviation) anomalies.push("Drop at row "+(i+1));
  });

  reportData = {
    column,
    avg: avg.toFixed(0),
    min: min.toFixed(0),
    max: max.toFixed(0),
    growth: growth.toFixed(1),
    trend: trendStrength.toFixed(1),
    forecast: forecastValues.slice(-forecastSteps),
    anomalies
  };

  updateDashboard(reportData);
  renderChart(forecastLabels, forecastValues, upper, lower, column);

  document.getElementById("output").innerHTML = "âœ… AI Analysis Complete";
}

// ================= UI =================
function updateDashboard(r){
  dashboard.style.display="block";
  statAvg.innerHTML = "ðŸ“Š Average: "+r.avg;
  statMin.innerHTML = "â¬‡ Min: "+r.min;
  statMax.innerHTML = "â¬† Max: "+r.max;
  statGrowth.innerHTML = "ðŸ“ˆ Growth: "+r.growth+"%";
  statTrend.innerHTML = "âš¡ Trend Strength: "+r.trend+"%";
  statForecast.innerHTML = "ðŸ¤– Forecast (5): "+r.forecast.join(", ");
  statAnomaly.innerHTML = "ðŸš¨ Anomalies: "+(r.anomalies.length?r.anomalies.join(", "):"None");
}

function renderChart(labels,data,upper,lower,name){
  const ctx = document.getElementById("chart").getContext("2d");
  if(chartInstance) chartInstance.destroy();

  chartInstance = new Chart(ctx,{
    type:"line",
    data:{
      labels,
      datasets:[
        {label:name,data,pointRadius:4,tension:.3},
        {label:"Upper Confidence",data:upper,borderDash:[5,5],pointRadius:0},
        {label:"Lower Confidence",data:lower,borderDash:[5,5],pointRadius:0}
      ]
    },
    options:{responsive:true}
  });
}

// ================= REPORT =================
function downloadReport(){
  if(!reportData) return alert("Run analysis first.");

  const text = `
INSIGHTFORGE PRO REPORT
-----------------------
Column: ${reportData.column}
Average: ${reportData.avg}
Min: ${reportData.min}
Max: ${reportData.max}
Growth: ${reportData.growth}%
Trend Strength: ${reportData.trend}%
Forecast (5): ${reportData.forecast.join(", ")}
Anomalies: ${reportData.anomalies.length?reportData.anomalies.join(", "):"None"}
`;

  const blob = new Blob([text],{type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download="insightforge_report.txt";
  a.click();
}
</script>

</body>
</html>
