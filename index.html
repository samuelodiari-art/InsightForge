<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PARAGON ANALYTICS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  font-family: system-ui, Arial;
  background: linear-gradient(135deg,#3b1d5f,#7a5c00);
  color:white;
  text-align:center;
  padding:18px;
}

h1{
  letter-spacing:2px;
  color:#ffd54a;
}

button{
  border:none;
  padding:14px 22px;
  margin:8px;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
}

.load{background:#5e35b1;color:white;}
.run{background:#ffd600;color:black;}
.pdf{background:#4527a0;color:white;}

select,input{padding:10px;border-radius:8px;margin:6px;}

.panel{
  background:rgba(255,255,255,0.08);
  border-radius:14px;
  padding:14px;
  margin-top:14px;
}

canvas{max-width:100%;margin-top:20px;}

.stat{margin:5px 0;}
</style>
</head>

<body>

<h1>PARAGON ANALYTICS</h1>
<p>Smart Business Intelligence & Forecasting</p>

<input type="file" id="fileInput" accept=".csv"><br>
<button class="load" onclick="loadCSV()">Load CSV</button><br>

<select id="columnSelect"></select><br>

<button class="run" onclick="runAnalysis()">Run AI Analysis</button>
<button class="pdf" onclick="downloadPDF()">Download Report PDF</button>

<div id="status" class="panel">Waiting for CSV...</div>

<canvas id="chart"></canvas>

<div id="insights" class="panel"></div>

<script>
let csvRows=[], chart=null, reportData=null;

function loadCSV(){
  const file=document.getElementById("fileInput").files[0];
  if(!file){ alert("Select CSV first"); return; }

  const reader=new FileReader();
  reader.onload=e=>{
    const text=e.target.result.trim();
    csvRows=text.split("\n").map(r=>r.split(","));
    const headers=csvRows[0];

    const sel=document.getElementById("columnSelect");
    sel.innerHTML="";
    headers.forEach(h=>{
      const opt=document.createElement("option");
      opt.value=h.trim();
      opt.textContent=h.trim();
      sel.appendChild(opt);
    });

    document.getElementById("status").innerText="CSV Loaded ✔";
  };
  reader.readAsText(file);
}

function cleanNumber(raw){
  if(!raw) return NaN;
  raw = raw.replace(/[^0-9.-]/g,"");   // remove commas, currency, spaces
  return parseFloat(raw);
}

/* --- Seasonal Detection --- */
function detectSeasonLength(n){
  if(n>=24) return 12;
  if(n>=12) return 6;
  if(n>=8) return 4;
  return 1;
}

function runAnalysis(){
  const colName=document.getElementById("columnSelect").value;
  const idx=csvRows[0].indexOf(colName);

  let values=[], labels=[];

  for(let i=1;i<csvRows.length;i++){
    const v=cleanNumber(csvRows[i][idx]);
    if(!isNaN(v)){
      values.push(v);
      labels.push("Row "+i);
    }
  }

  if(values.length<2){
    alert("Not enough valid numeric data found.");
    return;
  }

  /* ---- Basic Stats ---- */
  const sum=values.reduce((a,b)=>a+b,0);
  const avg=sum/values.length;
  const min=Math.min(...values);
  const max=Math.max(...values);
  const growth=((values.at(-1)-values[0])/values[0])*100;

  /* ---- Trend Forecast (Linear Regression) ---- */
  const x=values.map((_,i)=>i+1);
  const n=x.length;
  const sumX=x.reduce((a,b)=>a+b,0);
  const sumY=values.reduce((a,b)=>a+b,0);
  const sumXY=x.reduce((s,xi,i)=>s+xi*values[i],0);
  const sumX2=x.reduce((s,xi)=>s+xi*xi,0);

  const slope=(n*sumXY-sumX*sumY)/(n*sumX2-sumX*sumX);
  const intercept=(sumY-slope*sumX)/n;

  const horizon=5;
  let trendForecast=[];
  for(let i=1;i<=horizon;i++){
    const nx=n+i;
    trendForecast.push(Math.round(slope*nx+intercept));
  }

  /* ---- Seasonal Forecast ---- */
  const seasonLen = detectSeasonLength(values.length);
  let seasonIndex = new Array(seasonLen).fill(0);
  let counts = new Array(seasonLen).fill(0);

  values.forEach((v,i)=>{
    const s=i%seasonLen;
    seasonIndex[s]+=v;
    counts[s]++;
  });

  seasonIndex=seasonIndex.map((v,i)=>v/(counts[i]||1));
  const seasonAvg = seasonIndex.reduce((a,b)=>a+b,0)/seasonIndex.length;
  seasonIndex = seasonIndex.map(v=>v/seasonAvg);

  let seasonalForecast=[];
  for(let i=0;i<horizon;i++){
    seasonalForecast.push(
      Math.round(trendForecast[i]*seasonIndex[(n+i)%seasonLen])
    );
  }

  /* ---- Confidence ---- */
  const std=Math.sqrt(values.map(v=>(v-avg)**2).reduce((a,b)=>a+b)/values.length);
  const upper=seasonalForecast.map(v=>v+std);
  const lower=seasonalForecast.map(v=>Math.max(0,v-std));

  /* ---- Executive Summary ---- */
  const summary = `
The selected dataset shows an average value of ${avg.toFixed(0)} with growth of ${growth.toFixed(1)}%.
Trend analysis indicates a ${slope>0?"positive":"negative"} trajectory.
Seasonal behavior was detected with a cycle of approximately ${seasonLen} periods.
Forecast projections suggest stable forward performance with moderate variability.
This insight supports informed strategic planning and risk-aware decision making.
`;

  /* ---- Store Report ---- */
  reportData={
    column:colName,
    avg,min,max,growth,
    trendForecast,seasonalForecast,
    seasonLen,summary
  };

  /* ---- Chart ---- */
  const ctx=document.getElementById("chart").getContext("2d");
  if(chart) chart.destroy();

  const forecastLabels=[...labels];
  for(let i=1;i<=horizon;i++) forecastLabels.push("F"+i);

  chart=new Chart(ctx,{
    type:"line",
    data:{
      labels:forecastLabels,
      datasets:[
        {label:"Actual",data:values,borderWidth:3,tension:.3,pointRadius:4},
        {label:"Seasonal Forecast",
         data:new Array(values.length).fill(null).concat(seasonalForecast),
         borderDash:[6,4],borderWidth:3},
        {label:"Upper Confidence",
         data:new Array(values.length).fill(null).concat(upper),
         borderDash:[2,4]},
        {label:"Lower Confidence",
         data:new Array(values.length).fill(null).concat(lower),
         borderDash:[2,4]}
      ]
    }
  });

  document.getElementById("status").innerText="AI Analysis Complete ✔";

  document.getElementById("insights").innerHTML=`
  <b>Live Insights</b><br>
  Average: ${avg.toFixed(0)}<br>
  Min: ${min}<br>
  Max: ${max}<br>
  Growth: ${growth.toFixed(1)}%<br>
  Season Length: ${seasonLen}<br>
  Forecast: ${seasonalForecast.join(", ")}<br><br>
  <b>Summary</b><br>${summary}
  `;
}

/* ---- PDF Generator ---- */
async function downloadPDF(){
  if(!reportData){
    alert("Run analysis first.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF();

  pdf.setFontSize(18);
  pdf.text("PARAGON ANALYTICS",10,15);
  pdf.setFontSize(11);
  pdf.text("Smart Business Intelligence & Forecasting",10,22);

  pdf.setFontSize(12);
  pdf.text(`Column: ${reportData.column}`,10,35);
  pdf.text(`Average: ${reportData.avg.toFixed(0)}`,10,43);
  pdf.text(`Min: ${reportData.min}`,10,50);
  pdf.text(`Max: ${reportData.max}`,10,57);
  pdf.text(`Growth: ${reportData.growth.toFixed(1)}%`,10,64);
  pdf.text(`Season Length: ${reportData.seasonLen}`,10,71);
  pdf.text(`Forecast: ${reportData.seasonalForecast.join(", ")}`,10,78);

  pdf.text("Executive Summary:",10,95);
  pdf.text(pdf.splitTextToSize(reportData.summary,180),10,103);

  const img = document.getElementById("chart").toDataURL("image/png");
  pdf.addPage();
  pdf.text("Forecast Visualization",10,15);
  pdf.addImage(img,"PNG",10,25,180,100);

  pdf.save("Paragon_Analytics_Report.pdf");
}
</script>

</body>
</html>
