<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PARAGON ANALYTICS v1.2</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  background: radial-gradient(circle at top, #14002a, #050012);
  color: white;
  font-family: Arial, sans-serif;
  text-align: center;
}
button, select {
  padding: 10px;
  margin: 5px;
  border-radius: 6px;
  border: none;
  font-weight: bold;
}
.primary { background: gold; color:black; }
.secondary { background: #333; color:white; }
.panel { max-width:1200px; margin:auto; padding:10px; }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px; }
.card { background:rgba(255,255,255,0.08); padding:10px; border-radius:10px; }
.value { font-size:18px; font-weight:bold; }
canvas { background:rgba(255,255,255,0.05); border-radius:10px; margin-top:15px; }
textarea { width:95%; height:160px; border-radius:8px; padding:8px; }
.badge { padding:6px 14px; border-radius:20px; font-weight:bold; display:inline-block; }
.ok { background:#16a34a; }
.stable { background:#22c55e; }
.monitor { background:#f59e0b; }
.bad { background:#dc2626; }
</style>
</head>

<body>

<h2>PARAGON ANALYTICS v1.2</h2>
<p>Production-Grade Autonomous Business Intelligence Engine</p>

<input type="file" id="csvFile"><br>

<select id="metricSelect">
  <option value="units">Units Sold</option>
  <option value="revenue" selected>Revenue</option>
  <option value="cost">Cost</option>
  <option value="profit">Profit</option>
</select>

<select id="aggregationSelect">
  <option value="raw">Raw</option>
  <option value="week">Weekly</option>
  <option value="month" selected>Monthly</option>
  <option value="quarter">Quarterly</option>
</select>

<br>
<button class="primary" onclick="loadCSV()">Load CSV</button>
<button class="secondary" onclick="runAnalytics()">Run Intelligence</button>
<button class="secondary" onclick="exportPDF()">Export PDF</button>

<div id="validationBadge"></div>

<div class="panel">
<canvas id="lineChart"></canvas>
<canvas id="kpiChart"></canvas>
<canvas id="productChart"></canvas>
<canvas id="confidenceChart"></canvas>

<h3>Top Insights</h3>
<div class="grid" id="insightPanel"></div>

<h3>Risk & Intelligence</h3>
<div class="grid" id="riskPanel"></div>

<h3>Scenario Forecast</h3>
<div class="grid" id="scenarioPanel"></div>

<h3>AI Intelligence Report</h3>
<textarea id="aiText"></textarea>
</div>

<script>
let rawRows=[], headers=[], columnMap={}, charts={}, confidenceHistory=[];

/* ---------------- UTILITIES ---------------- */

function normalizeHeader(h){ return h.toLowerCase().replace(/[^a-z0-9]/g,""); }

function detectColumnMap(headers){
  const map={};
  headers.forEach((h,i)=>{
    const n=normalizeHeader(h);
    if(n.includes("date")) map.date=i;
    if(n.includes("product")||n.includes("item")) map.product=i;
    if(n.includes("unit")||n.includes("qty")) map.units=i;
    if(n.includes("revenue")||n.includes("sales")) map.revenue=i;
    if(n.includes("cost")||n.includes("expense")) map.cost=i;
    if(n.includes("profit")||n.includes("margin")) map.profit=i;
  });
  return map;
}

function sanitizeCell(v){
  if(v==null) return "";
  v=String(v).trim();
  if(/^[=+\-@]/.test(v)) v=v.replace(/^[=+\-@]/,"");
  return v;
}

function parseNumber(v){
  if(v===""||v==null) return null;
  let s=String(v).toLowerCase().replace(/[^0-9.\-k]/g,"");
  if(s.endsWith("k")) s=parseFloat(s)*1000;
  const n=Number(s);
  return Number.isFinite(n)?n:null;
}

function safeDiv(a,b){ return (!b||!isFinite(a)||!isFinite(b))?0:(a/b); }
function mean(a){ return a.length?a.reduce((x,y)=>x+y,0)/a.length:0; }
function std(a){ let m=mean(a); return Math.sqrt(mean(a.map(x=>(x-m)**2))); }

/* ---------------- CSV LOAD ---------------- */

function loadCSV(){
  const f=csvFile.files[0];
  if(!f) return alert("Upload CSV first.");
  const r=new FileReader();
  r.onload=e=>{
    const rows=e.target.result.trim().split(/\r?\n/);
    headers=rows[0].split(",").map(sanitizeCell);
    rawRows=rows.slice(1).map(r=>r.split(",").map(sanitizeCell));
    columnMap=detectColumnMap(headers);
    alert("CSV Loaded.");
  };
  r.readAsText(f);
}

/* ---------------- MAIN ---------------- */

function runAnalytics(){
  try{
    const metric=metricSelect.value;
    const col=columnMap[metric];
    if(col===undefined||columnMap.date===undefined)
      return alert("Required column missing.");

    let parsed=rawRows.map(r=>{
      return {
        date:new Date(r[columnMap.date]),
        value:parseNumber(r[col]),
        product:columnMap.product!==undefined?r[columnMap.product]:"All"
      };
    }).filter(r=>!isNaN(r.date));

    // Missing repair
    let last=null;
    parsed.forEach(p=>{
      if(p.value==null) p.value=last;
      else last=p.value;
    });
    const fallback=mean(parsed.map(p=>p.value).filter(v=>v!=null));
    parsed.forEach(p=>{ if(p.value==null) p.value=fallback||0; });

    const agg=aggregate(parsed);
    const values=agg.values;
    const labels=agg.labels;

    const smooth=expSmooth(values,0.35);
    const forecast=buildForecast(values,metric);

    const mape=calcMAPE(values,smooth);
    const seasonality=detectSeasonality(parsed);
    const volatility=safeDiv(std(values),mean(values))*100;
    const confidence=calcConfidence(volatility,mape,seasonality,values.length);
    confidenceHistory.push(confidence);

    const kpi=kpiCalc(values);
    const validation=validationEngine(confidence,mape,values.length);

    renderValidation(validation);
    renderConfidenceChart();
    renderInsights(confidence,mape,seasonality,validation);

    renderLine(labels,values,smooth,forecast);
    renderBars(kpi,segment(parsed));

    renderRisk(confidence,mape,seasonality,volatility);
    renderScenarios(forecast);
    renderAI(confidence,mape,seasonality,validation);

  }catch(e){
    console.error(e);
    alert("Safe failure – check file quality.");
  }
}

/* ---------------- AGGREGATION ---------------- */

function aggregate(data){
  let map={};
  data.forEach(d=>{
    const k=d.date.getFullYear()+"-"+(d.date.getMonth()+1);
    map[k]=(map[k]||0)+d.value;
  });
  const entries=Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0]));
  return {
    labels:entries.map(e=>e[0]),
    values:entries.map(e=>e[1])
  };
}

/* ---------------- MODELS ---------------- */

function expSmooth(d,a){
  let s=[d[0]];
  for(let i=1;i<d.length;i++) s.push(a*d[i]+(1-a)*s[i-1]);
  return s;
}

function buildForecast(values,metric){
  let t=(values.at(-1)-values.at(-2))||0;
  let scale=(metric==="units")?0.25:0.15;
  let vol=std(values)*scale;
  let base=[1,2,3].map(i=>Math.round(values.at(-1)+t*i));
  return {
    base,
    upper:base.map(v=>Math.round(v+vol)),
    lower:base.map(v=>Math.round(v-vol))
  };
}

function calcMAPE(a,s){
  let e=[];
  for(let i=1;i<a.length;i++)
    if(a[i]!==0) e.push(Math.abs((a[i]-s[i-1])/a[i]));
  return mean(e)*100;
}

function detectSeasonality(d){
  let m={};
  d.forEach(x=>{
    let k=x.date.getMonth();
    m[k]=(m[k]||0)+x.value;
  });
  let v=Object.values(m);
  return safeDiv(std(v),mean(v))*100;
}

function calcConfidence(vol,mape,season,n){
  let score=100-(vol*0.6+mape*0.8+season*0.3);
  score+=Math.min(30,n*2);
  return Math.max(35,Math.min(95,score));
}

/* ---------------- VALIDATION ENGINE ---------------- */

function validationEngine(conf,mape,n){
  if(conf>=75 && mape<=15 && n>=8) return "VALIDATED";
  if(conf>=65 && mape<=25) return "STABLE";
  if(conf>=50 || mape<=40) return "MONITOR";
  return "UNSTABLE";
}

function renderValidation(v){
  let cls="ok";
  if(v==="STABLE") cls="stable";
  if(v==="MONITOR") cls="monitor";
  if(v==="UNSTABLE") cls="bad";
  validationBadge.innerHTML=`<span class="badge ${cls}">${v}</span>`;
}

/* ---------------- INSIGHT RANKING ---------------- */

function renderInsights(conf,mape,season,validation){
  let insights=[];
  insights.push({score:mape, text:"Forecast error detected – improve data quality."});
  insights.push({score:season, text:"Strong seasonality – optimize inventory planning."});
  insights.push({score:100-conf, text:"Confidence trending lower – monitor stability."});
  insights.push({score:validation==="UNSTABLE"?80:10, text:"Validation risk – review dataset."});

  insights.sort((a,b)=>b.score-a.score);
  insightPanel.innerHTML = insights.slice(0,3)
    .map(i=>`<div class="card">${i.text}</div>`).join("");
}

/* ---------------- CHARTS ---------------- */

function renderConfidenceChart(){
  if(charts.conf) charts.conf.destroy();
  charts.conf=new Chart(confidenceChart,{
    type:"line",
    data:{
      labels:confidenceHistory.map((_,i)=>"Run "+(i+1)),
      datasets:[{label:"Confidence Strength",data:confidenceHistory}]
    }
  });
}

function renderLine(labels,a,s,f){
  if(charts.line) charts.line.destroy();
  charts.line=new Chart(lineChart,{
    type:"line",
    data:{
      labels:[...labels,"F1","F2","F3"],
      datasets:[
        {label:"Actual",data:a},
        {label:"Smoothed",data:s,borderDash:[5,5]},
        {label:"Forecast",data:[...Array(a.length).fill(null),...f.base]}
      ]
    }
  });
}

function renderBars(kpi,segments){
  if(charts.kpi) charts.kpi.destroy();
  if(charts.prod) charts.prod.destroy();
  charts.kpi=new Chart(kpiChart,{
    type:"bar",
    data:{labels:["Max","Min","Avg","Growth%"],datasets:[{data:[kpi.max,kpi.min,kpi.avg,kpi.growth]}]}
  });
  charts.prod=new Chart(productChart,{
    type:"bar",
    data:{labels:segments.labels,datasets:[{data:segments.values}]}
  });
}

/* ---------------- SUPPORT ---------------- */

function kpiCalc(d){
  return {
    max:Math.max(...d),
    min:Math.min(...d),
    avg:Math.round(mean(d)),
    growth:((d.at(-1)-d[0])/Math.abs(d[0])*100||0).toFixed(1)
  };
}

function segment(parsed){
  let m={};
  parsed.forEach(p=>m[p.product]=(m[p.product]||0)+p.value);
  return {labels:Object.keys(m),values:Object.values(m)};
}

function renderRisk(conf,mape,season,vol){
  riskPanel.innerHTML=`
  <div class="card">Confidence<div class="value">${conf.toFixed(1)}%</div></div>
  <div class="card">MAPE<div class="value">${mape.toFixed(1)}%</div></div>
  <div class="card">Seasonality<div class="value">${season.toFixed(1)}%</div></div>
  <div class="card">Volatility<div class="value">${vol.toFixed(1)}%</div></div>`;
}

function renderScenarios(f){
  scenarioPanel.innerHTML=`
  <div class="card">Base<div class="value">${f.base.join(", ")}</div></div>
  <div class="card">Upper<div class="value">${f.upper.join(", ")}</div></div>
  <div class="card">Lower<div class="value">${f.lower.join(", ")}</div></div>`;
}

function renderAI(conf,mape,season,validation){
  aiText.value=
`Confidence: ${conf.toFixed(1)}%
MAPE: ${mape.toFixed(1)}%
Seasonality: ${season.toFixed(1)}%
Validation Status: ${validation}`;
}

/* ---------------- PDF ---------------- */

async function exportPDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  pdf.text("PARAGON ANALYTICS v1.2 REPORT",10,10);
  pdf.addImage(lineChart.toDataURL("image/png"),"PNG",10,20,180,60);
  pdf.save("paragon_report.pdf");
}
</script>
</body>
  </html>
