# ================================
# PARAGON ANALYTICS â€” ALL IN ONE
# Single-file, copy-paste runnable
# ================================

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.backends.backend_pdf import PdfPages
from datetime import datetime
from sklearn.linear_model import LinearRegression
from sklearn.metrics import mean_absolute_error

# ----------------
# CONFIG
# ----------------
OUTPUT_PDF = "paragon_analytics_report.pdf"
RANDOM_SEED = 42
np.random.seed(RANDOM_SEED)

# ----------------
# DATA INGESTION
# ----------------
def load_data():
    """
    Replace this with CSV loading if needed.
    This mock dataset mirrors real business metrics.
    """
    dates = pd.date_range(start="2024-01-01", periods=12, freq="M")
    revenue = np.array([1200, 1350, 1500, 1480, 1600, 1750, 1800, 1950, 2100, 2200, 2350, 2500])
    expenses = np.array([700, 720, 760, 780, 800, 830, 850, 880, 910, 940, 960, 1000])

    df = pd.DataFrame({
        "date": dates,
        "revenue": revenue,
        "expenses": expenses
    })
    return df

# ----------------
# DATA VALIDATION
# ----------------
def validate_data(df):
    issues = []

    if df.isnull().any().any():
        issues.append("Missing values detected")

    if (df[["revenue", "expenses"]] < 0).any().any():
        issues.append("Negative financial values detected")

    if not pd.api.types.is_datetime64_any_dtype(df["date"]):
        issues.append("Date column is not datetime")

    return issues

# ----------------
# FEATURE ENGINEERING
# ----------------
def add_growth_metrics(df):
    df = df.copy()
    df["profit"] = df["revenue"] - df["expenses"]
    df["revenue_growth_pct"] = df["revenue"].pct_change() * 100
    df["profit_growth_pct"] = df["profit"].pct_change() * 100
    return df

# ----------------
# FORECAST ENGINE
# ----------------
def forecast_series(series, periods=3):
    X = np.arange(len(series)).reshape(-1, 1)
    y = series.values

    model = LinearRegression()
    model.fit(X, y)

    future_X = np.arange(len(series), len(series) + periods).reshape(-1, 1)
    forecast = model.predict(future_X)

    return forecast, model

# ----------------
# CHARTS
# ----------------
def plot_time_series(df, pdf):
    plt.figure()
    plt.plot(df["date"], df["revenue"], label="Revenue")
    plt.plot(df["date"], df["expenses"], label="Expenses")
    plt.plot(df["date"], df["profit"], label="Profit")
    plt.title("Revenue, Expenses & Profit Over Time")
    plt.legend()
    plt.tight_layout()
    pdf.savefig()
    plt.close()

def plot_growth(df, pdf):
    plt.figure()
    plt.plot(df["date"], df["revenue_growth_pct"], label="Revenue Growth %")
    plt.plot(df["date"], df["profit_growth_pct"], label="Profit Growth %")
    plt.axhline(0)
    plt.title("Growth Rates")
    plt.legend()
    plt.tight_layout()
    pdf.savefig()
    plt.close()

def plot_forecast(df, revenue_forecast, pdf):
    plt.figure()
    historical_x = range(len(df))
    forecast_x = range(len(df), len(df) + len(revenue_forecast))

    plt.plot(historical_x, df["revenue"], label="Historical Revenue")
    plt.plot(forecast_x, revenue_forecast, linestyle="--", label="Forecast Revenue")
    plt.title("Revenue Forecast")
    plt.legend()
    plt.tight_layout()
    pdf.savefig()
    plt.close()

# ----------------
# PDF REPORT
# ----------------
def generate_pdf(df, validation_issues, revenue_forecast):
    with PdfPages(OUTPUT_PDF) as pdf:
        # Summary page
        plt.figure()
        plt.axis("off")
        summary_text = f"""
        PARAGON ANALYTICS REPORT
        Generated: {datetime.now().strftime('%Y-%m-%d %H:%M')}

        Records analyzed: {len(df)}

        Avg Revenue: {df['revenue'].mean():.2f}
        Avg Expenses: {df['expenses'].mean():.2f}
        Avg Profit: {df['profit'].mean():.2f}

        Validation Issues:
        {', '.join(validation_issues) if validation_issues else 'None'}
        """
        plt.text(0.01, 0.99, summary_text, va="top")
        pdf.savefig()
        plt.close()

        plot_time_series(df, pdf)
        plot_growth(df, pdf)
        plot_forecast(df, revenue_forecast, pdf)

# ----------------
# MAIN PIPELINE
# ----------------
def run_paragon_analytics():
    print("Running Paragon Analytics...")

    df = load_data()
    print("Data loaded")

    validation_issues = validate_data(df)
    print("Validation complete:", validation_issues if validation_issues else "No issues")

    df = add_growth_metrics(df)
    print("Growth metrics added")

    revenue_forecast, model = forecast_series(df["revenue"])
    print("Forecast generated")

    generate_pdf(df, validation_issues, revenue_forecast)
    print(f"PDF report saved as {OUTPUT_PDF}")

    print("\n=== FINAL DATA SNAPSHOT ===")
    print(df.tail())

# ----------------
# EXECUTE
# ----------------
if __name__ == "__main__":
    run_paragon_analytics()
